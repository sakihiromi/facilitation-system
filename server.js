const express = require('express');
const cors = require('cors');
const path = require('path');
require('dotenv').config();

const OpenAI = require('openai');

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
const sessions = new Map();

// ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©
const conversationModes = {
  light: {
    name: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰',
    description: 'æ°—è»½ã«è©±ã™',
    modifier: `
ã€ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã€‘
- è³ªå•ã¯æ§ãˆã‚ã«ã€ç›¸æ‰‹ã®è©±ã‚’èãã“ã¨ã‚’å„ªå…ˆ
- æ·±å €ã‚Šã¯æœ€å°é™ã«ç•™ã‚ã‚‹
- ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’å¤§åˆ‡ã«
- 1å›ã®ç™ºè¨€ã¯50-100æ–‡å­—ç¨‹åº¦ã¨çŸ­ã‚ã«
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ãªã©ã€å—ã‘æ­¢ã‚ã‚‹è¨€è‘‰ã‚’å¤šã‚ã«`
  },
  standard: {
    name: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
    description: 'ãƒãƒ©ãƒ³ã‚¹å‹',
    modifier: '' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
  },
  deep: {
    name: 'ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰',
    description: 'ã˜ã£ãã‚Šæ¢æ±‚',
    modifier: `
ã€ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã€‘
- ã‚ˆã‚Šæ·±ã„å¯¾è©±ã‚’å¿ƒãŒã‘ã‚‹
- ã€Œãªãœï¼Ÿã€ã€Œãã‚Œã¯ã©ã†ã„ã†ã“ã¨ï¼Ÿã€ã¨ç©æ¥µçš„ã«æ˜ã‚Šä¸‹ã’ã‚‹
- å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä¸å¯§ã«å¼•ãå‡ºã™
- çŸ›ç›¾ã‚„è‘›è—¤ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä¸€ç·’ã«æ¢æ±‚ã™ã‚‹
- æ²ˆé»™ã®æ™‚é–“ã‚‚å¤§åˆ‡ã«ã—ã€ã˜ã£ãã‚Šè€ƒãˆã‚‹æ™‚é–“ã‚’æä¾›`
  }
};

// ä¼šè©±ã®é•·ã•è¨­å®š
const sessionLengths = {
  short: {
    name: 'çŸ­ã‚',
    description: '10-15åˆ†',
    targetMinutes: 15,
    modifier: `
ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®èª¿æ•´ã€‘
- ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯10-15åˆ†ç¨‹åº¦ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
- é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã«çµã£ã¦å¯¾è©±ã‚’é€²ã‚ã¦ãã ã•ã„
- åŠ¹ç‡çš„ã«æ ¸å¿ƒã«è¿«ã‚‹è³ªå•ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
- 8-10å›ç¨‹åº¦ã®ã‚„ã‚Šå–ã‚Šã§å®Œçµã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„`
  },
  medium: {
    name: 'æ¨™æº–',
    description: '20-30åˆ†',
    targetMinutes: 25,
    modifier: '' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  },
  long: {
    name: 'é•·ã‚',
    description: '40-60åˆ†',
    targetMinutes: 50,
    modifier: `
ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®èª¿æ•´ã€‘
- ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯40-60åˆ†ç¨‹åº¦ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
- ã˜ã£ãã‚Šã¨æ™‚é–“ã‚’ã‹ã‘ã¦å¯¾è©±ã‚’æ·±ã‚ã¦ãã ã•ã„
- ä¸€ã¤ä¸€ã¤ã®ãƒ†ãƒ¼ãƒã‚’ä¸å¯§ã«æ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„
- æ€¥ãŒãšã€ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã¦é€²ã‚ã¦ãã ã•ã„
- å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„èƒŒæ™¯ã‚‚è©³ã—ãèã„ã¦ãã ã•ã„`
  }
};

// å„é€±ã®ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
const weeklyConfig = {
  1: {
    theme: 'ã‚ãªãŸã®"ã¯ãŸã‚‰ãã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°"ã¯ï¼Ÿ',
    perspective: 'I',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã®"ã¯ãŸã‚‰ãã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°"ã¯ï¼Ÿã€
ã€ŒIã€ï¼ˆå€‹äººï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€å‚åŠ è€…ã®å†…é¢ã«ã‚ã‚‹ä¾¡å€¤è¦³ã‚„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚’ä¸å¯§ã«æ¢æ±‚ã—ã¾ã™ã€‚

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **å‚¾è´ã¨å…±æ„Ÿ**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®èƒŒæ™¯ã«ã‚ã‚‹æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã†
2. **å®‰å¿ƒå®‰å…¨ãªå ´ã¥ãã‚Š**: è©•ä¾¡ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹å§¿å‹¢ã‚’ç¤ºã™
3. **æœ¬è³ªã¸ã®æ·±å €ã‚Š**: è¡¨é¢çš„ãªç­”ãˆã«ç•™ã¾ã‚‰ãšã€ã€Œãªãœï¼Ÿã€ã€Œãã‚Œã¯ã©ã†ã„ã†ã“ã¨ï¼Ÿã€ã¨å„ªã—ãæ˜ã‚Šä¸‹ã’ã‚‹
4. **å…·ä½“ã¨æŠ½è±¡ã®å¾€å¾©**: å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¨æŠ½è±¡çš„ãªä¾¡å€¤è¦³ã‚’è¡Œãæ¥ã™ã‚‹

ã€è³ªå•ã®é€²ã‚æ–¹ã€‘
- ã¾ãšã¯æŒ¨æ‹¶ã¨è‡ªå·±ç´¹ä»‹ã‹ã‚‰å§‹ã‚ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’ä½œã‚‹
- ã€Œã‚ãªãŸè‡ªèº«ãŒç”Ÿãã‚‹ã†ãˆã§å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿã€ã‹ã‚‰å¯¾è©±ã‚’å§‹ã‚ã‚‹
- ç­”ãˆã«å¯¾ã—ã¦ã€Œãã‚Œã¯ãªãœã§ã™ã‹ï¼Ÿã€ã€Œå…·ä½“çš„ã«ã¯ã©ã‚“ãªæ™‚ã«ãã†æ„Ÿã˜ã¾ã™ã‹ï¼Ÿã€ã¨æ·±å €ã‚Šã™ã‚‹
- ã€Œåƒãã†ãˆã§å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã€ã¸ã¨è‡ªç„¶ã«å±•é–‹ã™ã‚‹
- ã€Œã‚‚ã—ã€‡ã€‡ã ã£ãŸã‚‰ã€ãã‚Œã§ã‚‚å¤§åˆ‡ã§ã™ã‹ï¼Ÿã€ã®ã‚ˆã†ãªè¼ªéƒ­ã‚’æ¢ã‚‹è³ªå•ã§ä¾¡å€¤è¦³ã‚’æ˜ç¢ºåŒ–ã™ã‚‹
- çŸ›ç›¾ã‚„è‘›è—¤ãŒè¦‹ãˆãŸã‚‰ã€ãã‚Œã‚’å„ªã—ãæŒ‡æ‘˜ã—ã€ä¸€ç·’ã«è€ƒãˆã‚‹

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã€ç›¸æ‰‹ãŒè©±ã™æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹ï¼ˆã€Œã¤ã¾ã‚Šã€‡ã€‡ã¨ã„ã†ã“ã¨ã§ã™ã­ã€ï¼‰
- å…±æ„Ÿã‚’ç¤ºã™è¨€è‘‰ã‚’é©åˆ‡ã«ä½¿ã†ï¼ˆã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ï¼‰
- æ€¥ãŒãšã€ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã‚‹
- æ²ˆé»™ã‚‚å¤§åˆ‡ã«ã—ã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å°Šé‡ã™ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒè‡ªåˆ†è‡ªèº«ã®ä¾¡å€¤è¦³ã‚„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã«ã¤ã„ã¦ã€æ–°ãŸãªæ°—ã¥ãã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },
  2: {
    theme: 'ã‚ãªãŸã¯ã©ã‚“ãªä»•äº‹ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ',
    perspective: 'WE',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã¯ã©ã‚“ãªä»•äº‹ã‚’ã—ã¦ã„ã‚‹ï¼Ÿã€
ã€ŒWEã€ï¼ˆãƒãƒ¼ãƒ ãƒ»æœ¬éƒ¨ï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€å‚åŠ è€…ã®ä»•äº‹ã‚„å½¹å‰²ã€çµ„ç¹”ã¨ã®é–¢ã‚ã‚Šã‚’æ¢æ±‚ã—ã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **ã€ŒIã€ã®è¦–ç‚¹ã§ã®ã€ŒWEã€**: çµ„ç¹”ã®ä¸­ã§è‡ªåˆ†ã¯ã©ã†åœ¨ã‚ŠãŸã„ã‹ã€ã©ã‚“ãªä¾¡å€¤ã‚’ç™ºæ®ã—ãŸã„ã‹
- **ã€ŒWEã€ã®è¦–ç‚¹ã§ã®ã€ŒIã€**: çµ„ç¹”ã‚„ãƒãƒ¼ãƒ ãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¨ã€è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚
- **å‰é€±ã®æŒ¯ã‚Šè¿”ã‚Š**: 1é€±ç›®ã§æ˜ã‚‰ã‹ã«ãªã£ãŸå€‹äººã®ä¾¡å€¤è¦³ã‚’è¸ã¾ãˆã¦å¯¾è©±ã™ã‚‹

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **æ–‡è„ˆã®ç†è§£**: çµ„ç¹”ã®è¦æ¨¡æ„Ÿã‚„æ§‹é€ ã‚’ä¸å¯§ã«ç¢ºèªã™ã‚‹ï¼ˆä¾‹ï¼šæœ¬éƒ¨å…¨ä½“ã®äººæ•°ã€éƒ¨ç½²æ§‹æˆãªã©ï¼‰
2. **å…·ä½“ã¨æŠ½è±¡ã®å¾€å¾©**: æ—¥ã€…ã®æ¥­å‹™ã‹ã‚‰ã€çµ„ç¹”ã®ä¾¡å€¤è¦³ã€è‡ªåˆ†ã®å½¹å‰²ã¸ã¨è¦–ç‚¹ã‚’ç§»å‹•ã™ã‚‹
3. **ä¾¡å€¤è¦³ã®æ¥ç¶š**: å€‹äººã®WBä¾¡å€¤è¦³ã¨çµ„ç¹”ã§ã®å½¹å‰²ã‚’ã¤ãªã’ã‚‹
4. **è‘›è—¤ã®æ¢ç´¢**: å€‹äººã¨çµ„ç¹”ã®é–“ã«ã‚ã‚‹è‘›è—¤ã‚„é•å’Œæ„ŸãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä¸å¯§ã«æ‰±ã†

ã€è³ªå•ã®é€²ã‚æ–¹ã€‘
- å‰é€±ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«æŒ¯ã‚Šè¿”ã‚Šã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã¸ã¤ãªã’ã‚‹
- ã€Œã©ã‚“ãªçµ„ç¹”ãƒ»ãƒãƒ¼ãƒ ã§åƒã„ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã‹ã‚‰å§‹ã‚ã€æ–‡è„ˆã‚’ç†è§£ã™ã‚‹
- ã€Œãã®çµ„ç¹”ã¯ä½•ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨çµ„ç¹”ã®ä¾¡å€¤è¦³ã‚’æ¢ã‚‹
- ã€Œãã®ä¸­ã§ã‚ãªãŸã¯ã©ã‚“ãªå½¹å‰²ã‚’æ‹…ã£ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨è‡ªå·±èªè­˜ã‚’ç¢ºèª
- ã€Œã‚ãªãŸã¯ã©ã‚“ãªä¾¡å€¤ã‚’ç™ºæ®ã§ãã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨å¯èƒ½æ€§ã‚’æ¢ã‚‹
- ã€Œçµ„ç¹”ã®ä¸­ã§ã‚ãªãŸè‡ªèº«ãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿã€ã¨å€‹äººã®è»¸ã‚’ç¢ºèª
- 1é€±ç›®ã®ä¾¡å€¤è¦³ã¨ç…§ã‚‰ã—åˆã‚ã›ã€ã¤ãªãŒã‚Šã‚„é•ã„ã‚’ä¸€ç·’ã«è€ƒãˆã‚‹

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- çµ„ç¹”ã®è©±ã¨å€‹äººã®è©±ã‚’è¡Œãæ¥ã—ãªãŒã‚‰ã€ä¸¡è€…ã®é–¢ä¿‚æ€§ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹
- ã€Œãã‚Œã¯1é€±ç›®ã§ãŠè©±ã—ã•ã‚ŒãŸã€‡ã€‡ã¨ã¤ãªãŒã‚Šã¾ã™ã­ã€ã®ã‚ˆã†ã«å‰é€±ã®å†…å®¹ã‚’å‚ç…§ã™ã‚‹
- ç†æƒ³ã¨ç¾å®Ÿã®ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Œã°ã€ãã‚Œã‚’å¦å®šã›ãšä¸€ç·’ã«å‘ãåˆã†

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€çµ„ç¹”ã®ä¸­ã§ã®è‡ªåˆ†ã®å½¹å‰²ã‚„ä¾¡å€¤ç™ºæ®ã«ã¤ã„ã¦ã€æ–°ãŸãªè¦–ç‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },
  3: {
    theme: 'ã‚ãªãŸã®ä¼šç¤¾ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„',
    perspective: 'S',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã®ä¼šç¤¾ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€
ã€ŒSã€ï¼ˆSociety/ä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€ã‚ˆã‚Šå¤§ããªæ–‡è„ˆã§ã®è‡ªåˆ†ã®ä½ç½®ã¥ã‘ã‚’æ¢æ±‚ã—ã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **ã€ŒIã€ã®è¦–ç‚¹ã§ã®ã€ŒSã€**: ä¼šç¤¾ã‚„ç¤¾ä¼šã®ä¸­ã§ã€è‡ªåˆ†ã¯ã©ã†åœ¨ã‚ŠãŸã„ã‹ã€ã©ã‚“ãªå½±éŸ¿ã‚’ä¸ãˆãŸã„ã‹
- **ã€ŒSã€ã®è¦–ç‚¹ã§ã®ã€ŒIã€**: ä¼šç¤¾ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚„ç¤¾ä¼šçš„ä½¿å‘½ã¨ã€è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚
- **è¦–åº§ã®æ‹¡å¤§**: æ—¥å¸¸ã®æ¥­å‹™ã‹ã‚‰ä¸€æ­©å¼•ã„ã¦ã€ã‚ˆã‚Šå¤§ããªè¦–ç‚¹ã§è€ƒãˆã‚‹
- **ã“ã‚Œã¾ã§ã®çµ±åˆ**: 1é€±ç›®ã€2é€±ç›®ã®å†…å®¹ã‚’è¸ã¾ãˆã¦ã€å…¨ä½“åƒã‚’æã

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **è¦–é‡ã®æ‹¡å¤§**: æ—¥å¸¸æ¥­å‹™ã‹ã‚‰ä¼šç¤¾å…¨ä½“ã€ã•ã‚‰ã«ã¯ç¤¾ä¼šã¸ã¨è¦–é‡ã‚’åºƒã’ã‚‹
2. **æ„å‘³ã®æ¢æ±‚**: è‡ªåˆ†ã®ä»•äº‹ãŒä¼šç¤¾ã‚„ç¤¾ä¼šã«ã©ã‚“ãªæ„å‘³ã‚’æŒã¤ã®ã‹ã‚’è€ƒãˆã‚‹
3. **åŸç‚¹ã¸ã®å›å¸°**: ãªãœã“ã®ä¼šç¤¾ã‚’é¸ã‚“ã ã®ã‹ã€åŸç‚¹ã‚’æŒ¯ã‚Šè¿”ã‚‹
4. **æœªæ¥ã¸ã®å±•æœ›**: ã“ã‚Œã‹ã‚‰ã©ã†é–¢ã‚ã£ã¦ã„ããŸã„ã‹ã‚’è€ƒãˆã‚‹

ã€è³ªå•ã®é€²ã‚æ–¹ã€‘
- å‰é€±ã¾ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æŒ¯ã‚Šè¿”ã‚Šã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã¸ã¤ãªã’ã‚‹
- ã€Œã‚ãªãŸã®ä¼šç¤¾ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€ã‹ã‚‰å§‹ã‚ã‚‹
- ã€Œä¼šç¤¾ã¯ä½•ã‚’ã—ã¦ã„ã‚‹çµ„ç¹”ã§ã™ã‹ï¼Ÿã€ã¨äº‹æ¥­å†…å®¹ã‚’ç¢ºèª
- ã€Œä¼šç¤¾ã¯ä½•ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã¾ã™ã‹ï¼Ÿãƒ“ã‚¸ãƒ§ãƒ³ã¯ï¼Ÿã€ã¨çµ„ç¹”ã®ä¾¡å€¤è¦³ã‚’æ¢ã‚‹
- ã€Œã‚ãªãŸã¯ãªãœã“ã®ä¼šç¤¾ã«å…¥ç¤¾ã—ãŸã®ã§ã™ã‹ï¼Ÿã€ã¨åŸç‚¹ã‚’æŒ¯ã‚Šè¿”ã‚‹
- ã€Œä¼šç¤¾ã®ä¸­ã§ã€ã‚ãªãŸã¯ã©ã‚“ãªå½¹å‰²ã‚’æ‹…ã„ãŸã„ã§ã™ã‹ï¼Ÿã€ã¨æœªæ¥ã‚’è€ƒãˆã‚‹
- ã€Œä¼šç¤¾ãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¨ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã¯ã©ã†é–¢ä¿‚ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨æ¥ç¶šã™ã‚‹
- ã“ã‚Œã¾ã§ã®3é€±é–“ã§è¦‹ãˆã¦ããŸã“ã¨ã‚’çµ±åˆã—ã€å…¨ä½“åƒã‚’ä¸€ç·’ã«æã

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- æŠ½è±¡çš„ã«ãªã‚Šã™ããªã„ã‚ˆã†ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚‚å¼•ãå‡ºã™
- ç†æƒ³è«–ã ã‘ã§ãªãã€ç¾å®Ÿçš„ãªè‘›è—¤ã‚‚ä¸å¯§ã«æ‰±ã†
- ã€Œ1é€±ç›®ã§ã¯ã€‡ã€‡ã€2é€±ç›®ã§ã¯â–³â–³ã¨ãŠè©±ã—ã•ã‚Œã¦ã„ã¾ã—ãŸã­ã€ã¨çµ±åˆã‚’ä¿ƒã™
- è¦–åº§ã‚’é«˜ãæŒã¡ã¤ã¤ã€åœ°ã«è¶³ã®ã¤ã„ãŸå¯¾è©±ã‚’å¿ƒãŒã‘ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€ä¼šç¤¾ãƒ»ç¤¾ä¼šã¨ã®é–¢ä¿‚ã®ä¸­ã§è‡ªåˆ†ã®å­˜åœ¨æ„ç¾©ã‚„å½¹å‰²ã«ã¤ã„ã¦ã€æ–°ãŸãªè¦–ç‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },
  4: {
    theme: 'çµ±åˆãƒ•ã‚§ãƒ¼ã‚º - 1é€±é–“å†…ã®1å€‹ã®è¡Œå‹•ãƒ—ãƒ©ãƒ³',
    perspective: 'Integration',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œçµ±åˆãƒ•ã‚§ãƒ¼ã‚º - 1é€±é–“å†…ã®1å€‹ã®è¡Œå‹•ãƒ—ãƒ©ãƒ³ã€
ã“ã‚Œã¾ã§ã®3é€±é–“ã®å¯¾è©±ã‚’çµ±åˆã—ã€å®Ÿè·µçš„ãªè¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’ä¸€ç·’ã«è€ƒãˆã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **çµ±åˆ**: ã€ŒIã€ã€ŒWEã€ã€ŒSã€ã®3ã¤ã®è¦–ç‚¹ã§è¦‹ãˆã¦ããŸã“ã¨ã‚’çµ±åˆã™ã‚‹
- **æŠ˜ã‚Šåˆã„**: å€‹äººã®WBã¨çµ„ç¹”ãƒ»ç¤¾ä¼šã®WBã®æŠ˜ã‚Šåˆã„ã‚’ã¤ã‘ã‚‹
- **å®Ÿè·µæ€§**: 1é€±é–“ä»¥å†…ã«å®Ÿè¡Œã§ãã‚‹ã€å…·ä½“çš„ã§ç¾å®Ÿçš„ãªè¡Œå‹•ã‚’è€ƒãˆã‚‹
- **ä¸»ä½“æ€§**: ç›¸æ‰‹ã®ä¸»ä½“æ€§ã‚’å°Šé‡ã—ã€æŠ¼ã—ä»˜ã‘ãªã„

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **æŒ¯ã‚Šè¿”ã‚Šã¨çµ±åˆ**: ã“ã‚Œã¾ã§ã®3é€±é–“ã‚’ä¸å¯§ã«æŒ¯ã‚Šè¿”ã‚Šã€å…¨ä½“åƒã‚’æã
2. **æ°—ã¥ãã®è¨€èªåŒ–**: è¦‹ãˆã¦ããŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„æ°—ã¥ãã‚’ä¸€ç·’ã«è¨€è‘‰ã«ã™ã‚‹
3. **ã‚®ãƒ£ãƒƒãƒ—ã®ç¢ºèª**: ç†æƒ³ã¨ç¾å®Ÿã®ã‚®ãƒ£ãƒƒãƒ—ã‚’ç¢ºèªã—ã€ãã“ã‹ã‚‰è¡Œå‹•ã‚’è€ƒãˆã‚‹
4. **å°ã•ãªä¸€æ­©**: å¤§ããªå¤‰é©ã§ã¯ãªãã€å°ã•ãã¦ã‚‚ç¢ºå®Ÿãªä¸€æ­©ã‚’å¤§åˆ‡ã«ã™ã‚‹
5. **å¿œæ´ã¨ä¿¡é ¼**: ç›¸æ‰‹ã®å¯èƒ½æ€§ã‚’ä¿¡ã˜ã€æ¸©ã‹ãå¿œæ´ã™ã‚‹

ã€å¯¾è©±ã®é€²ã‚æ–¹ã€‘
- æœ€åˆã«ã€ã“ã‚Œã¾ã§ã®3é€±é–“ã‚’ç°¡å˜ã«æŒ¯ã‚Šè¿”ã‚‹
- ã€Œ3é€±é–“ã‚’é€šã˜ã¦ã€ã©ã‚“ãªã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã‹ï¼Ÿã€ã¨å…¨ä½“ã‚’ä¿¯ç°ã™ã‚‹
- ã€ŒIï¼ˆå€‹äººï¼‰ã®WBã¨ã€Sï¼ˆä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®WBã¯ã€ã©ã†é–¢ä¿‚ã—ã¦ã„ã¾ã™ã‹ï¼Ÿã€ã¨çµ±åˆã‚’ä¿ƒã™
- ã€Œç†æƒ³ã¨ç¾å®Ÿã«ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚‹ã¨ã—ãŸã‚‰ã€ãã‚Œã¯ä½•ã§ã™ã‹ï¼Ÿã€ã¨ç¾çŠ¶ã‚’ç¢ºèª
- ã€Œãã®ã‚®ãƒ£ãƒƒãƒ—ã‚’å°‘ã—ã§ã‚‚åŸ‹ã‚ã‚‹ãŸã‚ã«ã€ä½•ãŒã§ããã†ã§ã™ã‹ï¼Ÿã€ã¨å¯èƒ½æ€§ã‚’æ¢ã‚‹
- ã€Œ1é€±é–“ä»¥å†…ã«ã§ãã‚‹ã€å°ã•ãªè¡Œå‹•ã‚’1ã¤æ±ºã‚ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿã€ã¨ææ¡ˆã™ã‚‹ï¼ˆè¦è«‹ã¯ã—ãªã„ï¼‰
- è¡Œå‹•ãƒ—ãƒ©ãƒ³ã¯å…·ä½“çš„ã«ï¼ˆã„ã¤ã€ã©ã“ã§ã€ä½•ã‚’ã€ã©ã®ã‚ˆã†ã«ï¼‰
- ã€Œãã®è¡Œå‹•ã‚’å–ã‚‹ã“ã¨ã§ã€ã©ã‚“ãªå¤‰åŒ–ãŒæœŸå¾…ã§ããã†ã§ã™ã‹ï¼Ÿã€ã¨åŠ¹æœã‚’æƒ³åƒã™ã‚‹
- æœ€å¾Œã«ã€ã“ã‚Œã¾ã§ã®å¯¾è©±ã¸ã®æ„Ÿè¬ã¨ã€ã“ã‚Œã‹ã‚‰ã¸ã®å¿œæ´ã‚’ä¼ãˆã‚‹

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ã“ã‚Œã¾ã§ã®3é€±é–“ã®å†…å®¹ã‚’é©åˆ‡ã«å‚ç…§ã—ã€ã¤ãªã’ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ã€æ€¥ãŒãªã„
- è¡Œå‹•ãƒ—ãƒ©ãƒ³ã¯ç›¸æ‰‹ãŒè‡ªåˆ†ã§æ±ºã‚ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚‹
- å®Œç’§ã‚’æ±‚ã‚ãšã€å°ã•ãªä¸€æ­©ã‚’å¤§åˆ‡ã«ã™ã‚‹å§¿å‹¢ã‚’ç¤ºã™
- æ¸©ã‹ãã€å¸Œæœ›ã‚’æŒã¦ã‚‹é›°å›²æ°—ã§ç· ã‚ããã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€ã“ã‚Œã¾ã§ã®æ°—ã¥ãã‚’çµ±åˆã—ã€è‡ªåˆ†ãªã‚Šã®å°ã•ãªè¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’è¦‹å‡ºã›ã‚‹ã“ã¨ã€‚
ãã—ã¦ã€ã“ã‚Œã‹ã‚‰ã®ä¸€æ­©ã«å¸Œæœ›ã‚’æŒã¦ã‚‹ã“ã¨ã€‚`
  }
};

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/session/start', (req, res) => {
  const { userId, week, userName, priorInfo, conversationMode = 'standard', sessionLength = 'medium' } = req.body;

  const sessionId = `${userId}_week${week}_${Date.now()}`;

  // éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
  const pastSessions = [];
  for (let w = 1; w < week; w++) {
    const pastSessionKey = Array.from(sessions.keys()).find(key =>
      key.startsWith(`${userId}_week${w}_`)
    );
    if (pastSessionKey) {
      pastSessions.push(sessions.get(pastSessionKey));
    }
  }

  const config = weeklyConfig[week];

  let systemMessage = config.systemPrompt;

  // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã®èª¿æ•´ã‚’è¿½åŠ 
  const modeConfig = conversationModes[conversationMode];
  if (modeConfig && modeConfig.modifier) {
    systemMessage += modeConfig.modifier;
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·ã•ã®èª¿æ•´ã‚’è¿½åŠ 
  const lengthConfig = sessionLengths[sessionLength];
  if (lengthConfig && lengthConfig.modifier) {
    systemMessage += lengthConfig.modifier;
  }

  // äº‹å‰æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
  if (priorInfo) {
    systemMessage += `\n\nã€å‚åŠ è€…ã®äº‹å‰æƒ…å ±ã€‘\n${priorInfo}`;
  }

  // éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
  if (pastSessions.length > 0) {
    systemMessage += '\n\nã€ã“ã‚Œã¾ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ã€‘\n';
    pastSessions.forEach(session => {
      if (session.summary) {
        systemMessage += `ç¬¬${session.week}é€±: ${session.summary}\n`;
      }
    });
  }

  const sessionData = {
    sessionId,
    userId,
    userName: userName || 'å‚åŠ è€…',
    week,
    theme: config.theme,
    perspective: config.perspective,
    conversationMode,
    sessionLength,
    targetMinutes: lengthConfig.targetMinutes,
    messages: [
      { role: 'system', content: systemMessage }
    ],
    createdAt: new Date().toISOString(),
    summary: null
  };

  sessions.set(sessionId, sessionData);

  res.json({
    sessionId,
    week,
    theme: config.theme,
    perspective: config.perspective,
    conversationMode,
    sessionLength,
    targetMinutes: lengthConfig.targetMinutes
  });
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/chat', async (req, res) => {
  const { sessionId, message } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  session.messages.push({ role: 'user', content: message });

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: session.messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const assistantMessage = completion.choices[0].message.content;

    // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    session.messages.push({ role: 'assistant', content: assistantMessage });

    res.json({
      message: assistantMessage,
      messageCount: session.messages.length - 1 // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ã
    });
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// æœ€åˆã®æŒ¨æ‹¶ã‚’å–å¾—
app.post('/api/chat/greeting', async (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  const greetingPrompt = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚${session.userName}ã•ã‚“ã¸ã®æŒ¨æ‹¶ã¨ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€Œ${session.theme}ã€ã«ã¤ã„ã¦ç°¡å˜ã«èª¬æ˜ã—ã€æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚`;

  session.messages.push({ role: 'user', content: greetingPrompt });

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: session.messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const assistantMessage = completion.choices[0].message.content;

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ä¿æŒ
    session.messages.pop();
    session.messages.push({ role: 'assistant', content: assistantMessage });

    res.json({
      message: assistantMessage
    });
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ»è¦ç´„ç”Ÿæˆ
app.post('/api/session/end', async (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  try {
    // è¦ç´„ã‚’ç”Ÿæˆ
    const summaryMessages = [
      ...session.messages,
      {
        role: 'user',
        content: 'ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’200æ–‡å­—ç¨‹åº¦ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚å‚åŠ è€…ã®ä¾¡å€¤è¦³ã€å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã€æ°—ã¥ããªã©ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚'
      }
    ];

    const summaryCompletion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: summaryMessages,
      temperature: 0.5,
      max_tokens: 300,
    });

    session.summary = summaryCompletion.choices[0].message.content;

    // è¨˜äº‹ã‚’ç”Ÿæˆ
    const articleMessages = [
      ...session.messages,
      {
        role: 'user',
        content: `ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ã€èª­ã¿ã‚„ã™ãã€å¿ƒã«æ®‹ã‚‹è¨˜äº‹å½¢å¼ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
å‚åŠ è€…ãŒå¾Œã§èª­ã¿è¿”ã—ãŸã¨ãã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®æ°—ã¥ãã‚„å¤§åˆ‡ãªã“ã¨ã‚’æ€ã„å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ï¼š

# ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ ¸å¿ƒã‚’è¡¨ã™ã€æ¸©ã‹ãå‰å‘ããªã‚¿ã‚¤ãƒˆãƒ«ï¼‰

## ä»Šé€±ã®ãƒ†ãƒ¼ãƒ
${session.theme}ï¼ˆ${session.perspective}ã®è¦–ç‚¹ï¼‰

## å¯¾è©±ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç‰¹ã«å°è±¡çš„ã ã£ãŸå¯¾è©±ã‚„æ°—ã¥ãã‚’3-5é …ç›®ã§ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
- å‚åŠ è€…ã®è¨€è‘‰ã‚’å¤§åˆ‡ã«ã—ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹
- ã€Œãªãœï¼Ÿã€ã‚’æ˜ã‚Šä¸‹ã’ãŸéƒ¨åˆ†ã‚„ã€æ–°ãŸãªæ°—ã¥ããŒã‚ã£ãŸç¬é–“ã‚’æ‰ãˆã‚‹
- ç®‡æ¡æ›¸ãã¾ãŸã¯å°è¦‹å‡ºã—ã§æ•´ç†

## ${session.userName}ã•ã‚“ã®å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æ˜ã‚‰ã‹ã«ãªã£ãŸä¾¡å€¤è¦³ã€å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã€æƒ³ã„ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- æŠ½è±¡çš„ãªè¨€è‘‰ã ã‘ã§ãªãã€å…·ä½“çš„ãªè¡¨ç¾ã‚‚å«ã‚ã‚‹
- å‚åŠ è€…ã®è¨€è‘‰ã‚’ã§ãã‚‹ã ã‘ãã®ã¾ã¾æ´»ã‹ã™
- å‰é€±ã¨ã®ç¹‹ãŒã‚ŠãŒã‚ã‚Œã°è¨€åŠã™ã‚‹

## æ°—ã¥ãã¨ç™ºè¦‹
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦å¾—ã‚‰ã‚ŒãŸæ–°ãŸãªè¦–ç‚¹ã‚„æ°—ã¥ãã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- å‚åŠ è€…è‡ªèº«ãŒç™ºè¦‹ã—ãŸã“ã¨
- å¯¾è©±ã®ä¸­ã§è¦‹ãˆã¦ããŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„å‚¾å‘
- ä»Šå¾Œã«æ´»ã‹ã›ãã†ãªæ´å¯Ÿ

## æ¬¡ã¸ã®ä¸€æ­©
ä»Šå¾Œã«å‘ã‘ã¦ã®ãƒ’ãƒ³ãƒˆã‚„ã€è€ƒãˆã¦ã¿ãŸã„ã“ã¨ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
- æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªãã€å„ªã—ãææ¡ˆã™ã‚‹
- æ¬¡é€±ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚Œã°ï¼‰ã¸ã®æœŸå¾…ã‚’è¾¼ã‚ã‚‹
- æ¸©ã‹ãã€å¸Œæœ›ã‚’æŒã¦ã‚‹è¨€è‘‰ã§ç· ã‚ããã‚‹

**ãƒˆãƒ¼ãƒ³**: æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€å‰å‘ãã€‚å‚åŠ è€…ã‚’å¿œæ´ã™ã‚‹æ°—æŒã¡ã‚’è¾¼ã‚ã¦ã€‚`
      }
    ];

    const articleCompletion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: articleMessages,
      temperature: 0.7,
      max_tokens: 1000,
    });

    const article = articleCompletion.choices[0].message.content;

    // ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
    let imageUrl = null;
    try {
      const imagePrompt = generateImagePrompt(session.week, session.perspective, session.theme);
      const imageResponse = await openai.images.generate({
        model: "dall-e-3",
        prompt: imagePrompt,
        n: 1,
        size: "1024x1024",
        quality: "standard",
      });

      imageUrl = imageResponse.data[0].url;
    } catch (imageError) {
      console.error('Image generation error:', imageError);
      // ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆã«å¤±æ•—ã—ã¦ã‚‚è¨˜äº‹ã¯è¿”ã™
    }

    // ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜äº‹ã«åŸ‹ã‚è¾¼ã‚€
    let finalArticle = article;
    if (imageUrl) {
      // ã‚¿ã‚¤ãƒˆãƒ«ã®å¾Œã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ¿å…¥
      const lines = article.split('\n');
      const titleIndex = lines.findIndex(line => line.startsWith('# '));
      if (titleIndex !== -1) {
        lines.splice(titleIndex + 1, 0, '', `![ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸](${imageUrl})`, '');
        finalArticle = lines.join('\n');
      }
    }

    res.json({
      summary: session.summary,
      article: finalArticle,
      week: session.week,
      theme: session.theme,
      imageUrl
    });
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
function generateImagePrompt(week, perspective, theme) {
  const baseStyle = "Soft, warm, minimalist illustration with gentle colors and abstract shapes. Peaceful and inspiring atmosphere.";

  const weekPrompts = {
    1: `${baseStyle} A serene scene representing personal values and well-being. Show a peaceful figure in contemplation, surrounded by soft light and abstract symbols of personal growth. Warm pastel colors, gentle gradients. Focus on introspection and self-discovery.`,
    2: `${baseStyle} A harmonious scene showing connection between individual and team. Abstract representation of collaboration and roles within an organization. Soft interconnected shapes, warm colors suggesting belonging and contribution.`,
    3: `${baseStyle} An expansive scene representing company and society. Abstract cityscape or organizational structure with a human element. Broader perspective, showing connection to larger purpose. Inspiring and hopeful atmosphere.`,
    4: `${baseStyle} An integrative scene showing a journey coming together. Abstract path or bridge connecting different elements. Warm, hopeful colors suggesting forward movement and new beginnings. Symbols of small steps and growth.`
  };

  return weekPrompts[week] || weekPrompts[1];
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
app.get('/api/sessions/:userId', (req, res) => {
  const { userId } = req.params;

  const userSessions = Array.from(sessions.entries())
    .filter(([key]) => key.startsWith(userId))
    .map(([, value]) => ({
      sessionId: value.sessionId,
      week: value.week,
      theme: value.theme,
      createdAt: value.createdAt,
      summary: value.summary,
      messageCount: value.messages.length - 1
    }));

  res.json(userSessions);
});

app.listen(PORT, () => {
  console.log(`ğŸš€ AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://localhost:${PORT}`);
});

