const express = require('express');
const cors = require('cors');
const path = require('path');
const fs = require('fs');
const https = require('https');
// Load .env from anken root
require('dotenv').config({ path: path.join(__dirname, '..', '..', '.env') });

const OpenAI = require('openai');

const app = express();
const PORT = process.env.FACILITATION_PORT || 3000;

// ç”»åƒä¿å­˜ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
const imagesDir = path.join(__dirname, 'public', 'images');
if (!fs.existsSync(imagesDir)) {
  fs.mkdirSync(imagesDir, { recursive: true });
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
const sessionsDir = path.join(__dirname, 'data', 'sessions');
if (!fs.existsSync(sessionsDir)) {
  fs.mkdirSync(sessionsDir, { recursive: true });
}

// å‡ºåŠ›ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
const outputDir = path.join(__dirname, 'output');
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ï¼‰
const sessions = new Map();

// ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–é–¢æ•°
function saveSessionToFile(sessionId, sessionData) {
  try {
    const filePath = path.join(sessionsDir, `${sessionId}.json`);
    const dataToSave = {
      ...sessionData,
      lastSavedAt: new Date().toISOString()
    };
    fs.writeFileSync(filePath, JSON.stringify(dataToSave, null, 2));
  } catch (error) {
    console.error('Session save error:', error);
  }
}

function loadSessionFromFile(sessionId) {
  try {
    const filePath = path.join(sessionsDir, `${sessionId}.json`);
    if (fs.existsSync(filePath)) {
      const data = fs.readFileSync(filePath, 'utf-8');
      return JSON.parse(data);
    }
    return null;
  } catch (error) {
    console.error('Session load error:', error);
    return null;
  }
}

function findUserWeekSessions(userId, week) {
  try {
    const files = fs.readdirSync(sessionsDir);
    const pattern = `${userId}_week${week}_`;
    const matchingFiles = files.filter(f => f.startsWith(pattern) && f.endsWith('.json'));

    if (matchingFiles.length > 0) {
      // æœ€æ–°ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿”ã™
      const sortedFiles = matchingFiles.sort().reverse();
      const sessionId = sortedFiles[0].replace('.json', '');
      return loadSessionFromFile(sessionId);
    }
    return null;
  } catch (error) {
    console.error('Session search error:', error);
    return null;
  }
}

// å‰å›ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’å–å¾—
function getPreviousSurveyResults(userId, currentWeek) {
  const surveysDir = path.join(__dirname, 'data', 'surveys');
  if (!fs.existsSync(surveysDir)) return null;

  try {
    const files = fs.readdirSync(surveysDir);
    // å‰ã®é€±ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’æ¢ã™
    const previousWeek = currentWeek - 1;
    if (previousWeek < 1) return null;

    const pattern = `survey_${userId}_week${previousWeek}_`;
    const matchingFiles = files.filter(f => f.startsWith(pattern) && f.endsWith('.json'));

    if (matchingFiles.length > 0) {
      // æœ€æ–°ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’å–å¾—
      const sortedFiles = matchingFiles.sort().reverse();
      const filepath = path.join(surveysDir, sortedFiles[0]);
      const data = fs.readFileSync(filepath, 'utf-8');
      return JSON.parse(data);
    }
    return null;
  } catch (error) {
    console.error('Survey load error:', error);
    return null;
  }
}

// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
function formatSurveyFeedback(surveyData) {
  if (!surveyData || !surveyData.responses) return '';

  const responses = surveyData.responses;
  let feedback = '\n\nã€å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€‘\n';
  feedback += 'å‚åŠ è€…ã‹ã‚‰ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ã‚’è¸ã¾ãˆã¦ã€ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ï¼š\n';

  // æº€è¶³åº¦
  if (responses.satisfaction) {
    const level = responses.satisfaction;
    if (level <= 2) {
      feedback += '- å‰å›ã®æº€è¶³åº¦ãŒä½ã‚ã§ã—ãŸã€‚ã‚ˆã‚Šä¸å¯§ã«ã€å‚åŠ è€…ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã¦é€²ã‚ã¦ãã ã•ã„ã€‚\n';
    } else if (level >= 4) {
      feedback += '- å‰å›ã¯æº€è¶³åº¦ãŒé«˜ã‹ã£ãŸã§ã™ã€‚åŒã˜èª¿å­ã§é€²ã‚ã¾ã—ã‚‡ã†ã€‚\n';
    }
  }

  // æ°—ã¥ã
  if (responses.awareness) {
    const level = responses.awareness;
    if (level <= 2) {
      feedback += '- å‰å›ã¯æ–°ã—ã„æ°—ã¥ããŒå°‘ãªã‹ã£ãŸã‚ˆã†ã§ã™ã€‚ã‚ˆã‚Šæ·±ã„è³ªå•ã‚„ã€ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®å•ã„ã‹ã‘ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚\n';
    } else if (level >= 4) {
      feedback += '- å‰å›ã¯å¤šãã®æ°—ã¥ããŒã‚ã£ãŸã‚ˆã†ã§ã™ã€‚ä»Šå›ã‚‚æ·±ã„å¯¾è©±ã‚’ç¶šã‘ã¾ã—ã‚‡ã†ã€‚\n';
    }
  }

  // è©±ã—ã‚„ã™ã•
  if (responses.ease) {
    const level = responses.ease;
    if (level <= 2) {
      feedback += '- å‰å›ã¯è©±ã—ã«ãã•ã‚’æ„Ÿã˜ã¦ã„ãŸã‚ˆã†ã§ã™ã€‚ã‚ˆã‚Šå—å®¹çš„ãªå§¿å‹¢ã§ã€ã‚†ã£ãã‚Šã¨ã—ãŸãƒšãƒ¼ã‚¹ã§é€²ã‚ã¦ãã ã•ã„ã€‚å…±æ„Ÿã®è¨€è‘‰ã‚’å¤šã‚ã«ä½¿ã„ã€æ²ˆé»™ã‚‚å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚\n';
    } else if (level >= 4) {
      feedback += '- å‰å›ã¯è©±ã—ã‚„ã™ã‹ã£ãŸã‚ˆã†ã§ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’ç¶­æŒã—ã¾ã—ã‚‡ã†ã€‚\n';
    }
  }

  // æ¬¡å›ã¸ã®æ„æ¬²
  if (responses.motivation) {
    const level = responses.motivation;
    if (level <= 2) {
      feedback += '- æ¬¡å›ã¸ã®æ„æ¬²ãŒä½ã‚ã§ã—ãŸã€‚ä»Šå›ã¯ç‰¹ã«æ¥½ã—ãã€ä¾¡å€¤ã®ã‚ã‚‹å¯¾è©±ã«ãªã‚‹ã‚ˆã†å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚å°ã•ãªæˆåŠŸä½“é¨“ã‚’æä¾›ã—ã¾ã—ã‚‡ã†ã€‚\n';
    }
  }

  // è‡ªç”±è¨˜è¿°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  if (responses.feedback) {
    feedback += `- å‚åŠ è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ: ã€Œ${responses.feedback}ã€\n`;
    feedback += '  ã“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è€ƒæ…®ã—ã¦ã€å¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚\n';
  }

  return feedback;
}

// å è¡“ã®ç¨®é¡å®šç¾©
const fortuneTypes = {
  // è¥¿æ´‹ç³»å è¡“
  tarot: 'ã‚¿ãƒ­ãƒƒãƒˆå ã„',
  western_astrology: 'è¥¿æ´‹å æ˜Ÿè¡“',
  numerology: 'æ•°ç§˜è¡“',
  kabbalah: 'ã‚«ãƒãƒ©æ•°ç§˜è¡“',
  runes: 'ãƒ«ãƒ¼ãƒ³å ã„',
  oracle_cards: 'ã‚ªãƒ©ã‚¯ãƒ«ã‚«ãƒ¼ãƒ‰',
  pendulum: 'ãƒšãƒ³ãƒ‡ãƒ¥ãƒ©ãƒ å ã„',
  crystal_ball: 'æ°´æ™¶å ã„',
  tea_leaves: 'èŒ¶è‘‰å ã„',
  palmistry: 'æ‰‹ç›¸å ã„',

  // æ±æ´‹ç³»å è¡“
  chinese_astrology: 'å››æŸ±æ¨å‘½',
  bazi: 'ç®—å‘½å­¦',
  ziwei_doushu: 'ç´«å¾®æ–—æ•°',
  nine_star_ki: 'ä¹æ˜Ÿæ°—å­¦',
  eki: 'æ˜“å ã„ï¼ˆå‘¨æ˜“ï¼‰',
  omikuji: 'ãŠã¿ãã˜',
  kigaku: 'æ°—å­¦',
  onmyodo: 'é™°é™½é“',

  // ã‚¤ãƒ³ãƒ‰ç³»å è¡“
  vedic_astrology: 'ã‚¤ãƒ³ãƒ‰å æ˜Ÿè¡“ï¼ˆã‚¸ãƒ§ãƒ¼ãƒ†ã‚£ã‚·ãƒ¥ï¼‰',

  // ãƒãƒ¤ãƒ»ã‚¢ã‚¹ãƒ†ã‚«ç³»
  mayan_astrology: 'ãƒãƒ¤æš¦å æ˜Ÿè¡“',
  aztec_astrology: 'ã‚¢ã‚¹ãƒ†ã‚«å æ˜Ÿè¡“',

  // èª•ç”Ÿæ—¥ç³»
  birth_flower: 'èª•ç”ŸèŠ±å ã„',
  birth_stone: 'èª•ç”ŸçŸ³å ã„',
  birth_color: 'èª•ç”Ÿè‰²å ã„',
  birthday_fortune: 'èª•ç”Ÿæ—¥å ã„',

  // åå‰ãƒ»æ–‡å­—ç³»
  name_numerology: 'å§“ååˆ¤æ–­',
  kanji_fortune: 'æ¼¢å­—å ã„',

  // ã‚ªãƒ¼ãƒ©ãƒ»ã‚¨ãƒãƒ«ã‚®ãƒ¼ç³»
  aura_reading: 'ã‚ªãƒ¼ãƒ©ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°',
  chakra_reading: 'ãƒãƒ£ã‚¯ãƒ©ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°',
  energy_healing: 'ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒ’ãƒ¼ãƒªãƒ³ã‚°',

  // å¿ƒç†ãƒ»æ€§æ ¼è¨ºæ–­ç³»
  mbti: 'MBTIè¨ºæ–­',
  enneagram: 'ã‚¨ãƒ‹ã‚¢ã‚°ãƒ©ãƒ ',
  big_five: 'ãƒ“ãƒƒã‚°ãƒ•ã‚¡ã‚¤ãƒ–æ€§æ ¼è¨ºæ–­',
  blood_type: 'è¡€æ¶²å‹å ã„',

  // å‹•ç‰©ãƒ»è‡ªç„¶ç³»
  animal_fortune: 'å‹•ç‰©å ã„',
  tree_fortune: 'æ¨¹æœ¨å ã„',
  flower_fortune: 'èŠ±å ã„',

  // ãã®ä»–
  dream_interpretation: 'å¤¢å ã„',
  feng_shui: 'é¢¨æ°´',
  face_reading: 'äººç›¸å ã„',
  graphology: 'ç­†è·¡å ã„',
  biorhythm: 'ãƒã‚¤ã‚ªãƒªã‚ºãƒ ',
  lucky_item: 'ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ å ã„',
  compatibility: 'ç›¸æ€§å ã„'
};

// ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã®å®šç¾©
const conversationModes = {
  light: {
    name: 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰',
    description: 'æ°—è»½ã«è©±ã™',
    modifier: `
ã€ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã€‘
- è³ªå•ã¯æ§ãˆã‚ã«ã€ç›¸æ‰‹ã®è©±ã‚’èãã“ã¨ã‚’å„ªå…ˆ
- æ·±å €ã‚Šã¯æœ€å°é™ã«ç•™ã‚ã‚‹
- ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’å¤§åˆ‡ã«
- 1å›ã®ç™ºè¨€ã¯50-100æ–‡å­—ç¨‹åº¦ã¨çŸ­ã‚ã«
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ãªã©ã€å—ã‘æ­¢ã‚ã‚‹è¨€è‘‰ã‚’å¤šã‚ã«`
  },
  standard: {
    name: 'ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
    description: 'ãƒãƒ©ãƒ³ã‚¹å‹',
    modifier: '' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãã®ã¾ã¾ä½¿ç”¨
  },
  deep: {
    name: 'ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰',
    description: 'ã˜ã£ãã‚Šæ¢æ±‚',
    modifier: `
ã€ä¼šè©±ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ã€‘
- ã‚ˆã‚Šæ·±ã„å¯¾è©±ã‚’å¿ƒãŒã‘ã‚‹
- ã€Œãªãœï¼Ÿã€ã€Œãã‚Œã¯ã©ã†ã„ã†ã“ã¨ï¼Ÿã€ã¨ç©æ¥µçš„ã«æ˜ã‚Šä¸‹ã’ã‚‹
- å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ä¸å¯§ã«å¼•ãå‡ºã™
- çŸ›ç›¾ã‚„è‘›è—¤ãŒã‚ã‚Œã°ã€ãã‚Œã‚’ä¸€ç·’ã«æ¢æ±‚ã™ã‚‹
- æ²ˆé»™ã®æ™‚é–“ã‚‚å¤§åˆ‡ã«ã—ã€ã˜ã£ãã‚Šè€ƒãˆã‚‹æ™‚é–“ã‚’æä¾›`
  }
};

// ä¼šè©±ã®é•·ã•è¨­å®š
const sessionLengths = {
  short: {
    name: 'çŸ­ã‚',
    description: '10-15åˆ†',
    targetMinutes: 15,
    modifier: `
ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®èª¿æ•´ã€‘
- ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯10-15åˆ†ç¨‹åº¦ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
- é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã«çµã£ã¦å¯¾è©±ã‚’é€²ã‚ã¦ãã ã•ã„
- åŠ¹ç‡çš„ã«æ ¸å¿ƒã«è¿«ã‚‹è³ªå•ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„
- 8-10å›ç¨‹åº¦ã®ã‚„ã‚Šå–ã‚Šã§å®Œçµã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„`
  },
  medium: {
    name: 'æ¨™æº–',
    description: '20-30åˆ†',
    targetMinutes: 25,
    modifier: `
ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®èª¿æ•´ã€‘
- ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯20-30åˆ†ç¨‹åº¦ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
- 15-20å›ç¨‹åº¦ã®ã‚„ã‚Šå–ã‚Šã§å®Œçµã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„
- ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå¯¾è©±ã‚’é€²ã‚ã¦ãã ã•ã„`
  },
  long: {
    name: 'é•·ã‚',
    description: '40-60åˆ†',
    targetMinutes: 50,
    modifier: `
ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã®èª¿æ•´ã€‘
- ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯40-60åˆ†ç¨‹åº¦ã‚’æƒ³å®šã—ã¦ã„ã¾ã™
- 25-35å›ç¨‹åº¦ã®ã‚„ã‚Šå–ã‚Šã§å®Œçµã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„
- ã˜ã£ãã‚Šã¨æ™‚é–“ã‚’ã‹ã‘ã¦å¯¾è©±ã‚’æ·±ã‚ã¦ãã ã•ã„
- ä¸€ã¤ä¸€ã¤ã®ãƒ†ãƒ¼ãƒã‚’ä¸å¯§ã«æ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„
- æ€¥ãŒãšã€ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã¦é€²ã‚ã¦ãã ã•ã„
- å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚„èƒŒæ™¯ã‚‚è©³ã—ãèã„ã¦ãã ã•ã„`
  }
};

// å„é€±ã®ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
const weeklyConfig = {
  1: {
    theme: 'ã‚ãªãŸã®"ã¯ãŸã‚‰ãã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°"ã¯ï¼Ÿ',
    perspective: 'I',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã®\"ã¯ãŸã‚‰ãã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°\"ã¯ï¼Ÿã€
ã€ŒIã€ï¼ˆå€‹äººï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€å‚åŠ è€…ã®å†…é¢ã«ã‚ã‚‹ä¾¡å€¤è¦³ã‚„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã‚’ä¸å¯§ã«æ¢æ±‚ã—ã¾ã™ã€‚

ã€å‚è€ƒï¼šå…¨ç¤¾å“¡èª¿æŸ»ã§å¤šãæŒ™ãŒã£ãŸä¾¡å€¤è¦³ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€‘
ä»¥ä¸‹ã¯éå»ã®èª¿æŸ»ã§ç¤¾å“¡ãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã¨å›ç­”ã—ãŸä¾¡å€¤è¦³ã§ã™ã€‚å¯¾è©±ã®ä¸­ã§è‡ªç„¶ã«å‚ç…§ã—ã¦ãã ã•ã„ï¼š
- æˆé•·ãƒ»å­¦ã³ãƒ»æŒ‘æˆ¦
- ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»å”åŠ›ãƒ»ä¿¡é ¼
- ãƒ¯ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ•ãƒãƒ©ãƒ³ã‚¹ãƒ»å®¶æ—
- èª å®Ÿã•ãƒ»æ­£ç›´ã•
- è²¢çŒ®ãƒ»ç¤¾ä¼šè²¢çŒ®
- è‡ªå¾‹ãƒ»è‡ªç”±ãƒ»ä¸»ä½“æ€§
- å¥åº·ãƒ»å¿ƒã®ä½™è£•
- é”æˆæ„Ÿãƒ»ã‚„ã‚ŠãŒã„
- å‰µé€ æ€§ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³
- å¤šæ§˜æ€§ãƒ»å°Šé‡

ã€é€£æƒ³ææ¡ˆï¼ˆã‚‚ã—ã‹ã—ã¦æ©Ÿèƒ½ï¼‰ã€‘
å‚åŠ è€…ã®ç™ºè¨€ã‹ã‚‰ä¾¡å€¤è¦³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰ãˆãŸã‚‰ã€é–¢é€£ã™ã‚‹ä¾¡å€¤è¦³ã‚’é€£æƒ³ã—ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ä¾‹ï¼š
- ã€Œæˆé•·ã‚’å¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ã‚‚ã—ã‹ã—ã¦ã€ã€æ–°ã—ã„ã“ã¨ã¸ã®æŒ‘æˆ¦ã€ã‚‚æ¥½ã—ã‚“ã§ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã‹ï¼Ÿã€
- ã€Œå®¶æ—ã¨ã®æ™‚é–“ã‚’å¤§äº‹ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ã²ã‚‡ã£ã¨ã™ã‚‹ã¨ã€ã€å¿ƒã®ä½™è£•ã€ã‚’æŒã¤ã“ã¨ã‚‚å¤§åˆ‡ã«ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€
- ã€Œãƒãƒ¼ãƒ ã§åƒãã“ã¨ãŒå¥½ããªã‚“ã§ã™ã­ã€‚ãã®ä¸­ã§ã€ä¿¡é ¼é–¢ä¿‚ã‚’ç¯‰ãã“ã¨ã€ã«ã‚‚ä¾¡å€¤ã‚’æ„Ÿã˜ã¦ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **ã¾ãšå—ã‘æ­¢ã‚ã‚‹**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è©•ä¾¡ã‚„åˆ¤æ–­ã‚’ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹
2. **å…±æ„Ÿã‚’ç¤ºã™**: ç›¸æ‰‹ã®æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ã¨å…±æ„Ÿã™ã‚‹
3. **ç›¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰æ¬¡ã‚’ç´¡ã**: å®šå‹çš„ãªè³ªå•ã¯é¿ã‘ã€ç›¸æ‰‹ãŒè©±ã—ãŸè¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
4. **å•ã„ã¯è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹**: ã€Œãªãœï¼Ÿã€ã¨èãå‰ã«ã€ã¾ãšç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã‚‹ã€‚å•ã„ã¯å¯¾è©±ã®æµã‚Œã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹

ã€å¯¾è©±ã®å¿ƒå¾—ã€‘
- å®šå‹çš„ãªè³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ã‚ãªã„
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®ä¸­ã‹ã‚‰æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
- è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãšå…±æ„Ÿã‚’ç¤ºã™
- æ²ˆé»™ã‚’æã‚Œãšã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆã«ã€æ€¥ãŒãªã„
- å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¨æŠ½è±¡çš„ãªä¾¡å€¤è¦³ã‚’è‡ªç„¶ã«è¡Œãæ¥ã™ã‚‹

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã€ç›¸æ‰‹ãŒè©±ã™æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹ï¼ˆã€Œã¤ã¾ã‚Šã€‡ã€‡ã¨ã„ã†ã“ã¨ã§ã™ã­ã€ï¼‰
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ãªã©ã€ã¾ãšå…±æ„Ÿã™ã‚‹
- è³ªå•ã¯ç›¸æ‰‹ã®è¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã‘ã«ã™ã‚‹
- æ²ˆé»™ã‚‚å¯¾è©±ã®ä¸€éƒ¨ã¨ã—ã¦å¤§åˆ‡ã«ã™ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒè‡ªåˆ†è‡ªèº«ã®ä¾¡å€¤è¦³ã‚„ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã«ã¤ã„ã¦ã€æ–°ãŸãªæ°—ã¥ãã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },

  2: {
    theme: 'é›‘è«‡ä¼š â˜•',
    perspective: 'Chat',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šå›ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œé›‘è«‡ä¼š â˜•ã€
Week 1ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚ãˆã¦ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã§å¯¾è©±ã‚’æ¥½ã—ã¿ã¾ã—ã‚‡ã†ã€‚

ã€ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç›®çš„ã€‘
1. **ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†**: å‰å›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ„Ÿæƒ³ã‚„æ”¹å–„ç‚¹ã‚’èã
2. **å€‹äººç†è§£ã®æ·±åŒ–**: è¶£å‘³ã€èˆˆå‘³ã€æ‚©ã¿ãªã©ã€ãã®äººã‚’ã‚ˆã‚Šæ·±ãçŸ¥ã‚‹
3. **å ã„ãƒ¢ãƒ¼ãƒ‰**: å¸Œæœ›ãŒã‚ã‚Œã°ã€å ã„ã‚’é€šã˜ã¦è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹
4. **ãƒªãƒ©ãƒƒã‚¯ã‚¹**: æ°—è»½ã«è©±ã›ã‚‹é›°å›²æ°—ã‚’ä½œã‚‹

ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®é–‹å§‹ã€‘
æœ€åˆã«ã€å‚åŠ è€…ã«ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

ã€Œä»Šæ—¥ã¯é›‘è«‡ä¼šã§ã™ï¼Week 1ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚
ä»Šæ—¥ã¯2ã¤ã®ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰é¸ã¹ã¾ã™ï¼š

1. **é›‘è«‡ãƒ¢ãƒ¼ãƒ‰**: ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã€è¶£å‘³ã‚„æœ€è¿‘ã®å‡ºæ¥äº‹ãªã©ã‚’è‡ªç”±ã«è©±ã™
2. **å ã„ãƒ¢ãƒ¼ãƒ‰**: å ã„ã‚’é€šã˜ã¦è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹ï¼ˆ30ç¨®é¡ä»¥ä¸Šã®å è¡“ã‹ã‚‰é¸ã¹ã¾ã™ï¼‰

ã©ã¡ã‚‰ãŒã„ã„ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ä¸¡æ–¹ã‚„ã£ã¦ã¿ã¾ã™ã‹ï¼Ÿã€

ã€é›‘è«‡ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€‘
- Week 1ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’èã
- è¶£å‘³ã€èˆˆå‘³ã€æ‚©ã¿ãªã©ã‚’è‡ªç„¶ã«å¼•ãå‡ºã™
- ä»•äº‹ä»¥å¤–ã®ãã®äººã‚’çŸ¥ã‚‹
- ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’å¤§åˆ‡ã«

ã€å ã„ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€‘
- å è¡“ã®é¸æŠã‚’ä¿ƒã™
- å¿…è¦ãªæƒ…å ±ã‚’èã
- å ã„ã®çµæœã‚’åˆ†ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹
- è‡ªå·±ç†è§£ã«ã¤ãªãŒã‚‹æ°—ã¥ãã‚’æä¾›

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **ã¾ãšå—ã‘æ­¢ã‚ã‚‹**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è©•ä¾¡ã‚„åˆ¤æ–­ã‚’ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹
2. **å…±æ„Ÿã‚’ç¤ºã™**: ç›¸æ‰‹ã®æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ã¨å…±æ„Ÿã™ã‚‹
3. **ç›¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰æ¬¡ã‚’ç´¡ã**: å®šå‹çš„ãªè³ªå•ã¯é¿ã‘ã€ç›¸æ‰‹ãŒè©±ã—ãŸè¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
4. **å•ã„ã¯è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹**: ã€Œãªãœï¼Ÿã€ã¨èãå‰ã«ã€ã¾ãšç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã‚‹

ã€å¯¾è©±ã®å¿ƒå¾—ã€‘
- å®šå‹çš„ãªè³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ã‚ãªã„
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®ä¸­ã‹ã‚‰æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
- è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãšå…±æ„Ÿã‚’ç¤ºã™
- æ²ˆé»™ã‚’æã‚Œãšã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆã«ã€æ€¥ãŒãªã„
- é›‘è«‡ãªã®ã§ã€æ¥½ã—ãã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã‚’å¤§åˆ‡ã«

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ã€Œé¢ç™½ã„ã§ã™ã­ã€ãªã©ã€ã¾ãšå…±æ„Ÿã™ã‚‹
- è³ªå•ã¯ç›¸æ‰‹ã®è¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã‘ã«ã™ã‚‹
- æ²ˆé»™ã‚‚å¯¾è©±ã®ä¸€éƒ¨ã¨ã—ã¦å¤§åˆ‡ã«ã™ã‚‹
- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯çœŸæ‘¯ã«å—ã‘æ­¢ã‚ã€æ”¹å–„ã«ã¤ãªã’ã‚‹å§¿å‹¢ã‚’ç¤ºã™

ã€ä»Šå›ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦è©±ã›ã€æ¬¡å›ä»¥é™ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ˆã‚Šè‰¯ã„ã‚‚ã®ã«ãªã‚‹ã“ã¨ã€‚
ãã—ã¦ã€ãã®äººè‡ªèº«ã‚’ã‚ˆã‚Šæ·±ãç†è§£ã™ã‚‹ã“ã¨ã€‚`
  },

  3: {
    theme: 'ã‚ãªãŸã¯ã©ã‚“ãªä»•äº‹ã‚’ã—ã¦ã„ã‚‹ï¼Ÿ',
    perspective: 'WE',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã¯ã©ã‚“ãªä»•äº‹ã‚’ã—ã¦ã„ã‚‹ï¼Ÿã€
ã€ŒWEã€ï¼ˆãƒãƒ¼ãƒ ãƒ»æœ¬éƒ¨ï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€å‚åŠ è€…ã®ä»•äº‹ã‚„å½¹å‰²ã€çµ„ç¹”ã¨ã®é–¢ã‚ã‚Šã‚’æ¢æ±‚ã—ã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **ã€ŒIã€ã®è¦–ç‚¹ã§ã®ã€ŒWEã€**: çµ„ç¹”ã®ä¸­ã§è‡ªåˆ†ã¯ã©ã†åœ¨ã‚ŠãŸã„ã‹ã€ã©ã‚“ãªä¾¡å€¤ã‚’ç™ºæ®ã—ãŸã„ã‹
- **ã€ŒWEã€ã®è¦–ç‚¹ã§ã®ã€ŒIã€**: çµ„ç¹”ã‚„ãƒãƒ¼ãƒ ãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã¨ã€è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚
- **å‰é€±ã®æŒ¯ã‚Šè¿”ã‚Š**: 1é€±ç›®ã§æ˜ã‚‰ã‹ã«ãªã£ãŸå€‹äººã®ä¾¡å€¤è¦³ã‚’è¸ã¾ãˆã¦å¯¾è©±ã™ã‚‹

ã€å¤šè§’çš„è¦–ç‚¹ã‹ã‚‰ã®å•ã„ã‹ã‘ï¼ˆé‡è¦ï¼‰ã€‘
å¯¾è©±ã®ä¸­ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¦–ç‚¹ã‹ã‚‰ã®å•ã„ã‹ã‘ã‚’è‡ªç„¶ã«çµ„ã¿è¾¼ã‚“ã§ãã ã•ã„ï¼š
- **éƒ¨ä¸‹ã‹ã‚‰ã®è¦–ç‚¹**: ã€Œéƒ¨ä¸‹ã®æ–¹ã‹ã‚‰è¦‹ãŸã‚ãªãŸã¯ã€ã©ã‚“ãªå­˜åœ¨ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€ã€Œéƒ¨ä¸‹ãŒã‚ãªãŸã«æœŸå¾…ã—ã¦ã„ã‚‹ã“ã¨ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€
- **åŒåƒšã‹ã‚‰ã®è¦–ç‚¹**: ã€ŒåŒåƒšã®æ–¹ã€…ã¯ã€ã‚ãªãŸã®ã©ã‚“ãªã¨ã“ã‚ã‚’é ¼ã‚Šã«ã—ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€
- **ä¸Šå¸ã‹ã‚‰ã®è¦–ç‚¹**: ã€Œä¸Šå¸ã®æ–¹ã¯ã€ã‚ãªãŸã«ã©ã‚“ãªå½¹å‰²ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿã€
- **ç¤¾å¤–ã®æ–¹ã‹ã‚‰ã®è¦–ç‚¹**: ã€ŒãŠå®¢æ§˜ã‚„å–å¼•å…ˆã®æ–¹ã‹ã‚‰è¦‹ãŸã‚ãªãŸã¯ï¼Ÿã€
- **æ¸…æƒã‚¹ã‚¿ãƒƒãƒ•ã‚„å—ä»˜ã®æ–¹ã‹ã‚‰ã®è¦–ç‚¹**: ã€Œæ™®æ®µã‚ã¾ã‚Šæ„è­˜ã—ãªã„æ–¹ã€…ã‹ã‚‰è¦‹ã¦ã€ã‚ãªãŸã¯ã©ã‚“ãªå°è±¡ã®äººã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿã€

ã“ã‚Œã‚‰ã®è¦–ç‚¹ã‚’é€šã˜ã¦ã€è‡ªåˆ†ã§ã¯æ°—ã¥ã„ã¦ã„ãªã„ä¾¡å€¤è¦³ã‚„å¼·ã¿ã‚’ç™ºè¦‹ã™ã‚‹æ©Ÿä¼šã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

ã€é€£æƒ³ææ¡ˆï¼ˆã‚‚ã—ã‹ã—ã¦æ©Ÿèƒ½ï¼‰ã€‘
å‚åŠ è€…ã®ç™ºè¨€ã‹ã‚‰ä¾¡å€¤è¦³ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ‰ãˆãŸã‚‰ã€é–¢é€£ã™ã‚‹ä¾¡å€¤è¦³ã‚’é€£æƒ³ã—ã¦ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ä¾‹ï¼š
- ã€Œãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚ã‚‚ã—ã‹ã—ã¦ã€ã€ä¸€äººã²ã¨ã‚Šã®æˆé•·ã€ã‚‚å¤§äº‹ã«ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€
- ã€Œè²¬ä»»æ„ŸãŒå¼·ã„ã®ã§ã™ã­ã€‚ã²ã‚‡ã£ã¨ã™ã‚‹ã¨ã€ã€ä¿¡é ¼ã•ã‚Œã‚‹å­˜åœ¨ã§ã‚ã‚ŠãŸã„ã€ã¨ã„ã†æ€ã„ã‚‚ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€
- ã€ŒåŠ¹ç‡ã‚’é‡è¦–ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã­ã€‚ãã®å¥¥ã«ã¯ã€ã¿ã‚“ãªã®æ™‚é–“ã‚’å¤§åˆ‡ã«ã—ãŸã„ã€ã¨ã„ã†æ°—æŒã¡ã‚‚ã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **ã¾ãšå—ã‘æ­¢ã‚ã‚‹**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è©•ä¾¡ã‚„åˆ¤æ–­ã‚’ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹
2. **å…±æ„Ÿã‚’ç¤ºã™**: ç›¸æ‰‹ã®æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ã¨å…±æ„Ÿã™ã‚‹
3. **ç›¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰æ¬¡ã‚’ç´¡ã**: å®šå‹çš„ãªè³ªå•ã¯é¿ã‘ã€ç›¸æ‰‹ãŒè©±ã—ãŸè¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
4. **å•ã„ã¯è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹**: ã€Œãªãœï¼Ÿã€ã¨èãå‰ã«ã€ã¾ãšç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã‚‹ã€‚å•ã„ã¯å¯¾è©±ã®æµã‚Œã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹

ã€å¯¾è©±ã®å¿ƒå¾—ã€‘
- å®šå‹çš„ãªè³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ã‚ãªã„
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®ä¸­ã‹ã‚‰æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
- è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãšå…±æ„Ÿã‚’ç¤ºã™
- æ²ˆé»™ã‚’æã‚Œãšã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆã«ã€æ€¥ãŒãªã„
- çµ„ç¹”ã®è©±ã¨å€‹äººã®è©±ã‚’è‡ªç„¶ã«è¡Œãæ¥ã™ã‚‹
- å‰é€±ã®å†…å®¹ã‚’è‡ªç„¶ã«å‚ç…§ã—ã€ã¤ãªãŒã‚Šã‚’è¦‹å‡ºã™

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ãªã©ã€ã¾ãšå…±æ„Ÿã™ã‚‹
- è³ªå•ã¯ç›¸æ‰‹ã®è¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã‘ã«ã™ã‚‹
- ã€Œãã‚Œã¯1é€±ç›®ã§ãŠè©±ã—ã•ã‚ŒãŸã€‡ã€‡ã¨ã¤ãªãŒã‚Šã¾ã™ã­ã€ã®ã‚ˆã†ã«å‰é€±ã®å†…å®¹ã‚’è‡ªç„¶ã«å‚ç…§ã™ã‚‹
- ç†æƒ³ã¨ç¾å®Ÿã®ã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Œã°ã€ãã‚Œã‚’å¦å®šã›ãšä¸€ç·’ã«å‘ãåˆã†
- æ²ˆé»™ã‚‚å¯¾è©±ã®ä¸€éƒ¨ã¨ã—ã¦å¤§åˆ‡ã«ã™ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€çµ„ç¹”ã®ä¸­ã§ã®è‡ªåˆ†ã®å½¹å‰²ã‚„ä¾¡å€¤ç™ºæ®ã«ã¤ã„ã¦ã€æ–°ãŸãªè¦–ç‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },
  4: {
    theme: 'ã‚ãªãŸã®ä¼šç¤¾ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„',
    perspective: 'S',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œã‚ãªãŸã®ä¼šç¤¾ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„ã€
ã€ŒSã€ï¼ˆSociety/ä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã€ã‚ˆã‚Šå¤§ããªæ–‡è„ˆã§ã®è‡ªåˆ†ã®ä½ç½®ã¥ã‘ã‚’æ¢æ±‚ã—ã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **ã€ŒIã€ã®è¦–ç‚¹ã§ã®ã€ŒSã€**: ä¼šç¤¾ã‚„ç¤¾ä¼šã®ä¸­ã§ã€è‡ªåˆ†ã¯ã©ã†åœ¨ã‚ŠãŸã„ã‹ã€ã©ã‚“ãªå½±éŸ¿ã‚’ä¸ãˆãŸã„ã‹
- **ã€ŒSã€ã®è¦–ç‚¹ã§ã®ã€ŒIã€**: ä¼šç¤¾ã®ãƒ“ã‚¸ãƒ§ãƒ³ã‚„ç¤¾ä¼šçš„ä½¿å‘½ã¨ã€è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚
- **è¦–åº§ã®æ‹¡å¤§**: æ—¥å¸¸ã®æ¥­å‹™ã‹ã‚‰ä¸€æ­©å¼•ã„ã¦ã€ã‚ˆã‚Šå¤§ããªè¦–ç‚¹ã§è€ƒãˆã‚‹
- **ã“ã‚Œã¾ã§ã®çµ±åˆ**: 1é€±ç›®ã€2é€±ç›®ã®å†…å®¹ã‚’è¸ã¾ãˆã¦ã€å…¨ä½“åƒã‚’æã

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **ã¾ãšå—ã‘æ­¢ã‚ã‚‹**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è©•ä¾¡ã‚„åˆ¤æ–­ã‚’ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹
2. **å…±æ„Ÿã‚’ç¤ºã™**: ç›¸æ‰‹ã®æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ã¨å…±æ„Ÿã™ã‚‹
3. **ç›¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰æ¬¡ã‚’ç´¡ã**: å®šå‹çš„ãªè³ªå•ã¯é¿ã‘ã€ç›¸æ‰‹ãŒè©±ã—ãŸè¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
4. **å•ã„ã¯è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹**: ã€Œãªãœï¼Ÿã€ã¨èãå‰ã«ã€ã¾ãšç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã‚‹ã€‚å•ã„ã¯å¯¾è©±ã®æµã‚Œã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹

ã€å¯¾è©±ã®å¿ƒå¾—ã€‘
- å®šå‹çš„ãªè³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ã‚ãªã„
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®ä¸­ã‹ã‚‰æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
- è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãšå…±æ„Ÿã‚’ç¤ºã™
- æ²ˆé»™ã‚’æã‚Œãšã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆã«ã€æ€¥ãŒãªã„
- æ—¥å¸¸æ¥­å‹™ã‹ã‚‰ä¼šç¤¾å…¨ä½“ã€ç¤¾ä¼šã¸ã¨è¦–é‡ã‚’è‡ªç„¶ã«åºƒã’ã‚‹
- ã“ã‚Œã¾ã§ã®2é€±é–“ã®å†…å®¹ã‚’è‡ªç„¶ã«å‚ç…§ã—ã€çµ±åˆã‚’ä¿ƒã™

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ãªã©ã€ã¾ãšå…±æ„Ÿã™ã‚‹
- è³ªå•ã¯ç›¸æ‰‹ã®è¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã‘ã«ã™ã‚‹
- æŠ½è±¡çš„ã«ãªã‚Šã™ããªã„ã‚ˆã†ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚‚å¼•ãå‡ºã™
- ç†æƒ³è«–ã ã‘ã§ãªãã€ç¾å®Ÿçš„ãªè‘›è—¤ã‚‚ä¸å¯§ã«æ‰±ã†
- ã€Œ1é€±ç›®ã§ã¯ã€‡ã€‡ã€2é€±ç›®ã§ã¯â–³â–³ã¨ãŠè©±ã—ã•ã‚Œã¦ã„ã¾ã—ãŸã­ã€ã¨çµ±åˆã‚’ä¿ƒã™
- è¦–åº§ã‚’é«˜ãæŒã¡ã¤ã¤ã€åœ°ã«è¶³ã®ã¤ã„ãŸå¯¾è©±ã‚’å¿ƒãŒã‘ã‚‹
- æ²ˆé»™ã‚‚å¯¾è©±ã®ä¸€éƒ¨ã¨ã—ã¦å¤§åˆ‡ã«ã™ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€ä¼šç¤¾ãƒ»ç¤¾ä¼šã¨ã®é–¢ä¿‚ã®ä¸­ã§è‡ªåˆ†ã®å­˜åœ¨æ„ç¾©ã‚„å½¹å‰²ã«ã¤ã„ã¦ã€æ–°ãŸãªè¦–ç‚¹ã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚`
  },
  5: {
    theme: 'çµ±åˆãƒ•ã‚§ãƒ¼ã‚º - 1é€±é–“å†…ã®1å€‹ã®è¡Œå‹•ãƒ—ãƒ©ãƒ³',
    perspective: 'Integration',
    systemPrompt: `ã‚ãªãŸã¯å„ªç§€ãªAIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€ç›¸æ‰‹ã®æœ¬è³ªã‚’å¼•ãå‡ºã™ã“ã¨ã«é•·ã‘ã¦ã„ã¾ã™ã€‚

ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€‘
ã€Œçµ±åˆãƒ•ã‚§ãƒ¼ã‚º - 1é€±é–“å†…ã®1å€‹ã®è¡Œå‹•ãƒ—ãƒ©ãƒ³ã€
ã“ã‚Œã¾ã§ã®3é€±é–“ã®å¯¾è©±ã‚’çµ±åˆã—ã€å®Ÿè·µçš„ãªè¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’ä¸€ç·’ã«è€ƒãˆã¾ã™ã€‚

ã€é‡è¦ãªè¦–ç‚¹ã€‘
- **çµ±åˆ**: ã€ŒIã€ã€ŒWEã€ã€ŒSã€ã®3ã¤ã®è¦–ç‚¹ã§è¦‹ãˆã¦ããŸã“ã¨ã‚’çµ±åˆã™ã‚‹
- **æŠ˜ã‚Šåˆã„**: å€‹äººã®WBã¨çµ„ç¹”ãƒ»ç¤¾ä¼šã®WBã®æŠ˜ã‚Šåˆã„ã‚’ã¤ã‘ã‚‹
- **å®Ÿè·µæ€§**: 1é€±é–“ä»¥å†…ã«å®Ÿè¡Œã§ãã‚‹ã€å…·ä½“çš„ã§ç¾å®Ÿçš„ãªè¡Œå‹•ã‚’è€ƒãˆã‚‹
- **ä¸»ä½“æ€§**: ç›¸æ‰‹ã®ä¸»ä½“æ€§ã‚’å°Šé‡ã—ã€æŠ¼ã—ä»˜ã‘ãªã„

ã€ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸå‰‡ã€‘
1. **ã¾ãšå—ã‘æ­¢ã‚ã‚‹**: ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è©•ä¾¡ã‚„åˆ¤æ–­ã‚’ã›ãšã€ã‚ã‚Šã®ã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹
2. **å…±æ„Ÿã‚’ç¤ºã™**: ç›¸æ‰‹ã®æƒ³ã„ã‚„æ„Ÿæƒ…ã«å¯„ã‚Šæ·»ã„ã€ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ã¨å…±æ„Ÿã™ã‚‹
3. **ç›¸æ‰‹ã®è¨€è‘‰ã‹ã‚‰æ¬¡ã‚’ç´¡ã**: å®šå‹çš„ãªè³ªå•ã¯é¿ã‘ã€ç›¸æ‰‹ãŒè©±ã—ãŸè¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
4. **å•ã„ã¯è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹**: ã€Œãªãœï¼Ÿã€ã¨èãå‰ã«ã€ã¾ãšç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã‚‹ã€‚å•ã„ã¯å¯¾è©±ã®æµã‚Œã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹
5. **å¿œæ´ã¨ä¿¡é ¼**: ç›¸æ‰‹ã®å¯èƒ½æ€§ã‚’ä¿¡ã˜ã€æ¸©ã‹ãå¿œæ´ã™ã‚‹

ã€å¯¾è©±ã®å¿ƒå¾—ã€‘
- å®šå‹çš„ãªè³ªå•ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä½¿ã‚ãªã„
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ä¸å¯§ã«å—ã‘æ­¢ã‚ã€ãã®ä¸­ã‹ã‚‰æ¬¡ã®å•ã„ã‚’è¦‹ã¤ã‘ã‚‹
- è³ªå•ã™ã‚‹å‰ã«ã€ã¾ãšå…±æ„Ÿã‚’ç¤ºã™
- æ²ˆé»™ã‚’æã‚Œãšã€ç›¸æ‰‹ãŒè€ƒãˆã‚‹æ™‚é–“ã‚’å¤§åˆ‡ã«ã™ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’æœ€å„ªå…ˆã«ã€æ€¥ãŒãªã„
- ã“ã‚Œã¾ã§ã®3é€±é–“ã‚’è‡ªç„¶ã«æŒ¯ã‚Šè¿”ã‚Šã€çµ±åˆã‚’ä¿ƒã™
- è¡Œå‹•ãƒ—ãƒ©ãƒ³ã¯ç›¸æ‰‹ãŒè‡ªåˆ†ã§æ±ºã‚ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚‹
- å°ã•ãªä¸€æ­©ã‚’å¤§åˆ‡ã«ã—ã€å®Œç’§ã‚’æ±‚ã‚ãªã„

ã€å¯¾è©±ã®ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- 1å›ã®ç™ºè¨€ã¯100-200æ–‡å­—ç¨‹åº¦ã«æŠ‘ãˆã‚‹
- ç›¸æ‰‹ã®è¨€è‘‰ã‚’ãã®ã¾ã¾å—ã‘æ­¢ã‚ã€è¨€ã„æ›ãˆã¦ç¢ºèªã™ã‚‹
- ã€Œãã†ãªã‚“ã§ã™ã­ã€ã€Œãªã‚‹ã»ã©ã€ã€Œå¤§åˆ‡ã«ã•ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€ãªã©ã€ã¾ãšå…±æ„Ÿã™ã‚‹
- è³ªå•ã¯ç›¸æ‰‹ã®è¨€è‘‰ã®ä¸­ã‹ã‚‰è‡ªç„¶ã«ç”Ÿã¾ã‚Œã‚‹ã‚‚ã®ã ã‘ã«ã™ã‚‹
- ã“ã‚Œã¾ã§ã®3é€±é–“ã®å†…å®¹ã‚’é©åˆ‡ã«å‚ç…§ã—ã€ã¤ãªã’ã‚‹
- ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã‚’å°Šé‡ã—ã€æ€¥ãŒãªã„
- è¡Œå‹•ãƒ—ãƒ©ãƒ³ã¯ç›¸æ‰‹ãŒè‡ªåˆ†ã§æ±ºã‚ã‚‹ã“ã¨ã‚’å¤§åˆ‡ã«ã™ã‚‹
- å®Œç’§ã‚’æ±‚ã‚ãšã€å°ã•ãªä¸€æ­©ã‚’å¤§åˆ‡ã«ã™ã‚‹å§¿å‹¢ã‚’ç¤ºã™
- æ¸©ã‹ãã€å¸Œæœ›ã‚’æŒã¦ã‚‹é›°å›²æ°—ã§ç· ã‚ããã‚‹
- æ²ˆé»™ã‚‚å¯¾è©±ã®ä¸€éƒ¨ã¨ã—ã¦å¤§åˆ‡ã«ã™ã‚‹

ã€ä»Šé€±ã®ç›®æ¨™ã€‘
å‚åŠ è€…ãŒã€ã“ã‚Œã¾ã§ã®æ°—ã¥ãã‚’çµ±åˆã—ã€è‡ªåˆ†ãªã‚Šã®å°ã•ãªè¡Œå‹•ãƒ—ãƒ©ãƒ³ã‚’è¦‹å‡ºã›ã‚‹ã“ã¨ã€‚
ãã—ã¦ã€ã“ã‚Œã‹ã‚‰ã®ä¸€æ­©ã«å¸Œæœ›ã‚’æŒã¦ã‚‹ã“ã¨ã€‚`
  }
};

// å ã„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•°
function getFortunePrompt(fortuneType, userInfo) {
  const fortuneName = fortuneTypes[fortuneType];

  return `
ã€å ã„ãƒ¢ãƒ¼ãƒ‰: ${fortuneName}ã€‘

ã‚ãªãŸã¯${fortuneName}ã®å°‚é–€å®¶ã§ã‚‚ã‚ã‚Šã¾ã™ã€‚
å‚åŠ è€…: ${userInfo.userName}

å ã„ã®é€²ã‚æ–¹:
1. å¿…è¦ãªæƒ…å ±ã‚’è‡ªç„¶ã«èã
2. ${fortuneName}ã®æ‰‹æ³•ã«åŸºã¥ã„ã¦åˆ†æ
3. çµæœã‚’åˆ†ã‹ã‚Šã‚„ã™ãã€å‰å‘ãã«ä¼ãˆã‚‹
4. ä»•äº‹ã‚„äººç”Ÿã«æ´»ã‹ã›ã‚‹æ°—ã¥ãã‚’æä¾›
5. å ã„ã¯ã‚ãã¾ã§è‡ªå·±ç†è§£ã®ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã†

é‡è¦: 
- æ–­å®šçš„ãªè¡¨ç¾ã¯é¿ã‘ã€ã€Œã€œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã€Œã€œã®å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€ã¨ã„ã†æŸ”ã‚‰ã‹ã„è¡¨ç¾ã‚’ä½¿ã†
- ãƒã‚¬ãƒ†ã‚£ãƒ–ãªçµæœã‚‚ã€æˆé•·ã®æ©Ÿä¼šã¨ã—ã¦å‰å‘ãã«ä¼ãˆã‚‹
- å ã„ã‚’æ¥½ã—ã¿ãªãŒã‚‰ã‚‚ã€è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹ã“ã¨ã‚’é‡è¦–ã™ã‚‹
- å°‚é–€çš„ã™ãã‚‹ç”¨èªã¯é¿ã‘ã€åˆ†ã‹ã‚Šã‚„ã™ãèª¬æ˜ã™ã‚‹
`;
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/session/start', (req, res) => {
  const { userId, userName, priorInfo, conversationMode = 'standard', sessionLength = 'medium' } = req.body;
  const week = parseInt(req.body.week, 10); // æ–‡å­—åˆ—ã‹ã‚‰æ•´æ•°ã«å¤‰æ›

  const sessionId = `${userId}_week${week}_${Date.now()}`;

  // éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
  const pastSessions = [];
  for (let w = 1; w < week; w++) {
    const pastSessionKey = Array.from(sessions.keys()).find(key =>
      key.startsWith(`${userId}_week${w}_`)
    );
    if (pastSessionKey) {
      pastSessions.push(sessions.get(pastSessionKey));
    }
  }

  console.log(`Session start requested: week=${week}, type=${typeof week}, weeklyConfig keys=${Object.keys(weeklyConfig).join(', ')}`);
  
  const config = weeklyConfig[week];

  // é€±ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  if (!config) {
    console.error(`é€± ${week} ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    return res.status(400).json({ 
      error: `é€± ${week} ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æœ‰åŠ¹ãªé€±: ${Object.keys(weeklyConfig).join(', ')}` 
    });
  }

  let systemMessage = config.systemPrompt;

  // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰ã®èª¿æ•´ã‚’è¿½åŠ 
  const modeConfig = conversationModes[conversationMode];
  if (modeConfig && modeConfig.modifier) {
    systemMessage += modeConfig.modifier;
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·ã•ã®èª¿æ•´ã‚’è¿½åŠ 
  const lengthConfig = sessionLengths[sessionLength];
  if (lengthConfig && lengthConfig.modifier) {
    systemMessage += lengthConfig.modifier;
  }

  // äº‹å‰æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
  if (priorInfo) {
    systemMessage += `\n\nã€å‚åŠ è€…ã®äº‹å‰æƒ…å ±ã€‘\n${priorInfo}`;
  }

  // éå»ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚ã‚Œã°è¿½åŠ 
  if (pastSessions.length > 0) {
    systemMessage += '\n\nã€ã“ã‚Œã¾ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è¦ç´„ã€‘\n';
    pastSessions.forEach(session => {
      if (session.summary) {
        systemMessage += `ç¬¬${session.week}é€±: ${session.summary}\n`;
      }
    });
  }

  // å‰å›ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœãŒã‚ã‚Œã°è¿½åŠ ï¼ˆæ¬¡å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ´»ã‹ã™ï¼‰
  const previousSurvey = getPreviousSurveyResults(userId, week);
  if (previousSurvey) {
    const surveyFeedback = formatSurveyFeedback(previousSurvey);
    if (surveyFeedback) {
      systemMessage += surveyFeedback;
      console.log(`å‰å›(Week ${week - 1})ã®ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«åæ˜ ã—ã¾ã—ãŸ`);
    }
  }

  const sessionData = {
    sessionId,
    userId,
    userName: userName || 'å‚åŠ è€…',
    week,
    theme: config.theme,
    perspective: config.perspective,
    conversationMode,
    sessionLength,
    targetMinutes: lengthConfig.targetMinutes,
    messages: [
      { role: 'system', content: systemMessage }
    ],
    createdAt: new Date().toISOString(),
    summary: null
  };

  sessions.set(sessionId, sessionData);
  saveSessionToFile(sessionId, sessionData);

  res.json({
    sessionId,
    week,
    theme: config.theme,
    perspective: config.perspective,
    conversationMode,
    sessionLength,
    targetMinutes: lengthConfig.targetMinutes
  });
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/chat', async (req, res) => {
  const { sessionId, message } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
  session.messages.push({ role: 'user', content: message });

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: session.messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const assistantMessage = completion.choices[0].message.content;

    // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    session.messages.push({ role: 'assistant', content: assistantMessage });

    // è‡ªå‹•ä¿å­˜
    saveSessionToFile(sessionId, session);

    res.json({
      message: assistantMessage,
      messageCount: session.messages.length - 1 // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é™¤ã
    });
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// æœ€åˆã®æŒ¨æ‹¶ã‚’å–å¾—
app.post('/api/chat/greeting', async (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  const greetingPrompt = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚${session.userName}ã•ã‚“ã¸ã®æŒ¨æ‹¶ã¨ã€ä»Šé€±ã®ãƒ†ãƒ¼ãƒã€Œ${session.theme}ã€ã«ã¤ã„ã¦ç°¡å˜ã«èª¬æ˜ã—ã€æœ€åˆã®è³ªå•ã‚’ã—ã¦ãã ã•ã„ã€‚`;

  session.messages.push({ role: 'user', content: greetingPrompt });

  try {
    const completion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: session.messages,
      temperature: 0.7,
      max_tokens: 500,
    });

    const assistantMessage = completion.choices[0].message.content;

    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ä¿æŒ
    session.messages.pop();
    session.messages.push({ role: 'assistant', content: assistantMessage });

    res.json({
      message: assistantMessage
    });
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'AIå¿œç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ãƒ»è¦ç´„ç”Ÿæˆ
app.post('/api/session/end', async (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  try {
    // è¦ç´„ã‚’ç”Ÿæˆ
    const summaryMessages = [
      ...session.messages,
      {
        role: 'user',
        content: 'ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’200æ–‡å­—ç¨‹åº¦ã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚å‚åŠ è€…ã®ä¾¡å€¤è¦³ã€å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã€æ°—ã¥ããªã©ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚'
      }
    ];

    const summaryCompletion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: summaryMessages,
      temperature: 0.5,
      max_tokens: 300,
    });

    session.summary = summaryCompletion.choices[0].message.content;

    // è¨˜äº‹ã‚’ç”Ÿæˆï¼ˆå¤šè§’çš„è¦–ç‚¹ã‹ã‚‰ï¼‰
    const articleMessages = [
      ...session.messages,
      {
        role: 'user',
        content: `ä»Šå›ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ã€èª­ã¿ã‚„ã™ãã€å¿ƒã«æ®‹ã‚‹è¨˜äº‹å½¢å¼ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
å‚åŠ è€…ãŒå¾Œã§èª­ã¿è¿”ã—ãŸã¨ãã«ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®æ°—ã¥ãã‚„å¤§åˆ‡ãªã“ã¨ã‚’æ€ã„å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ï¼š

# ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ ¸å¿ƒã‚’è¡¨ã™ã€æ¸©ã‹ãå‰å‘ããªã‚¿ã‚¤ãƒˆãƒ«ï¼‰

## ä»Šé€±ã®ãƒ†ãƒ¼ãƒ
${session.theme}ï¼ˆ${session.perspective}ã®è¦–ç‚¹ï¼‰

## å¯¾è©±ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç‰¹ã«å°è±¡çš„ã ã£ãŸå¯¾è©±ã‚„æ°—ã¥ãã‚’3-5é …ç›®ã§ç´¹ä»‹ã—ã¦ãã ã•ã„ã€‚
- å‚åŠ è€…ã®è¨€è‘‰ã‚’å¤§åˆ‡ã«ã—ã€å…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’å«ã‚ã‚‹
- ã€Œãªãœï¼Ÿã€ã‚’æ˜ã‚Šä¸‹ã’ãŸéƒ¨åˆ†ã‚„ã€æ–°ãŸãªæ°—ã¥ããŒã‚ã£ãŸç¬é–“ã‚’æ‰ãˆã‚‹
- ç®‡æ¡æ›¸ãã¾ãŸã¯å°è¦‹å‡ºã—ã§æ•´ç†

## ${session.userName}ã•ã‚“ã®å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨
ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§æ˜ã‚‰ã‹ã«ãªã£ãŸä¾¡å€¤è¦³ã€å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ã€æƒ³ã„ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- æŠ½è±¡çš„ãªè¨€è‘‰ã ã‘ã§ãªãã€å…·ä½“çš„ãªè¡¨ç¾ã‚‚å«ã‚ã‚‹
- å‚åŠ è€…ã®è¨€è‘‰ã‚’ã§ãã‚‹ã ã‘ãã®ã¾ã¾æ´»ã‹ã™
- å‰é€±ã¨ã®ç¹‹ãŒã‚ŠãŒã‚ã‚Œã°è¨€åŠã™ã‚‹

## å¤šè§’çš„è¦–ç‚¹ã‹ã‚‰ã®åˆ†æ
ã€é‡è¦ã€‘ä»¥ä¸‹ã®3ã¤ã®è¦–ç‚¹ã‹ã‚‰ã€å‚åŠ è€…ã®ä¾¡å€¤è¦³ã‚’åˆ†æã—ã¦ãã ã•ã„ï¼š

### ã€ŒIã€ï¼ˆå€‹äººï¼‰ã®è¦–ç‚¹ã‹ã‚‰
- å€‹äººã¨ã—ã¦å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³
- è‡ªåˆ†è‡ªèº«ã®ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°ã«ã¨ã£ã¦é‡è¦ãªã“ã¨
- å†…é¢çš„ãªå¼·ã¿ã‚„ç‰¹æ€§

### ã€ŒWEã€ï¼ˆãƒãƒ¼ãƒ ãƒ»çµ„ç¹”ï¼‰ã®è¦–ç‚¹ã‹ã‚‰
- ãƒãƒ¼ãƒ ã‚„çµ„ç¹”ã®ä¸­ã§ã®å½¹å‰²æ„è­˜
- ä»–è€…ã¨ã®é–¢ä¿‚æ€§ã«ãŠã„ã¦å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨
- å‘¨å›²ã‹ã‚‰è¦‹ãŸè‡ªåˆ†ã®å¼·ã¿ï¼ˆæ¨æ¸¬ã‚’å«ã‚€ï¼‰

### ã€ŒSã€ï¼ˆä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®è¦–ç‚¹ã‹ã‚‰
- ä¼šç¤¾ã‚„ç¤¾ä¼šã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ãªè²¢çŒ®ã‚’ã—ãŸã„ã‹
- ã‚ˆã‚Šå¤§ããªè¦–ç‚¹ã§ã®è‡ªåˆ†ã®å­˜åœ¨æ„ç¾©
- ç¤¾ä¼šçš„ãªä¾¡å€¤è¦³ã¨ã®é–¢ä¿‚

## æ°—ã¥ãã¨ç™ºè¦‹
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é€šã˜ã¦å¾—ã‚‰ã‚ŒãŸæ–°ãŸãªè¦–ç‚¹ã‚„æ°—ã¥ãã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚
- å‚åŠ è€…è‡ªèº«ãŒç™ºè¦‹ã—ãŸã“ã¨
- å¯¾è©±ã®ä¸­ã§è¦‹ãˆã¦ããŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚„å‚¾å‘
- ä»Šå¾Œã«æ´»ã‹ã›ãã†ãªæ´å¯Ÿ

## æ¬¡ã¸ã®ä¸€æ­©
ä»Šå¾Œã«å‘ã‘ã¦ã®ãƒ’ãƒ³ãƒˆã‚„ã€è€ƒãˆã¦ã¿ãŸã„ã“ã¨ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
- æŠ¼ã—ä»˜ã‘ãŒã¾ã—ããªãã€å„ªã—ãææ¡ˆã™ã‚‹
- æ¬¡é€±ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚ã‚Œã°ï¼‰ã¸ã®æœŸå¾…ã‚’è¾¼ã‚ã‚‹
- æ¸©ã‹ãã€å¸Œæœ›ã‚’æŒã¦ã‚‹è¨€è‘‰ã§ç· ã‚ããã‚‹

**ãƒˆãƒ¼ãƒ³**: æ¸©ã‹ãã€å…±æ„Ÿçš„ã§ã€å‰å‘ãã€‚å‚åŠ è€…ã‚’å¿œæ´ã™ã‚‹æ°—æŒã¡ã‚’è¾¼ã‚ã¦ã€‚`
      }
    ];

    const articleCompletion = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: articleMessages,
      temperature: 0.7,
      max_tokens: 1000,
    });

    const article = articleCompletion.choices[0].message.content;

    // ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
    let imageUrl = null;
    let localImagePath = null;
    try {
      const imagePrompt = generateImagePrompt(session.week, session.perspective, session.theme);
      const imageResponse = await openai.images.generate({
        model: "dall-e-3",
        prompt: imagePrompt,
        n: 1,
        size: "1024x1024",
        quality: "standard",
      });

      imageUrl = imageResponse.data[0].url;

      // ä¸€æ™‚URLã‹ã‚‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
      try {
        localImagePath = await downloadAndSaveImage(imageUrl, session.sessionId);
        console.log('Image saved locally:', localImagePath);
      } catch (downloadError) {
        console.error('Image download error:', downloadError);
        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ãŸå ´åˆã¯ä¸€æ™‚URLã‚’ä½¿ç”¨
        localImagePath = imageUrl;
      }
    } catch (imageError) {
      console.error('Image generation error:', imageError);
      // ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆã«å¤±æ•—ã—ã¦ã‚‚è¨˜äº‹ã¯è¿”ã™
    }

    // ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜äº‹ã«åŸ‹ã‚è¾¼ã‚€ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã‚’ä½¿ç”¨ï¼‰+ ç”»åƒã®èª¬æ˜ã‚’è¿½åŠ 
    let finalArticle = article;
    const displayImageUrl = localImagePath || imageUrl;
    if (displayImageUrl) {
      // ç”»åƒã®èª¬æ˜ã‚’å–å¾—
      const imageDescription = getImageDescription(session.week, session.perspective, session.theme);
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã®å¾Œã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨èª¬æ˜ã‚’æŒ¿å…¥
      const lines = article.split('\n');
      const titleIndex = lines.findIndex(line => line.startsWith('# '));
      if (titleIndex !== -1) {
        lines.splice(titleIndex + 1, 0, 
          '', 
          `![ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸](${displayImageUrl})`,
          '',
          `> **ğŸ–¼ï¸ ã“ã®å›³ã«ã¤ã„ã¦**`,
          `> ${imageDescription}`,
          ''
        );
        finalArticle = lines.join('\n');
      }
    }

    // ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã«ä¿å­˜
    session.article = finalArticle;
    session.summary = session.summary; // æ—¢ã«ä¿å­˜æ¸ˆã¿
    session.completedAt = new Date().toISOString();
    session.isCompleted = true;
    session.imageUrl = displayImageUrl;

    // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    saveSessionToFile(sessionId, session);

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
    res.json({
      summary: session.summary,
      article: finalArticle,
      week: session.week,
      theme: session.theme,
      imageUrl: displayImageUrl
    });

    // 5é€±ç›®ã®å ´åˆã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡å¾Œã«è£ã§å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯é€šçŸ¥ã—ãªã„ï¼‰
    if (session.week === 5) {
      setImmediate(async () => {
        try {
          console.log('5é€±ç›®å®Œäº†: å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç”Ÿæˆä¸­...');
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
          const allSessions = getAllUserSessions(session.userId);
          const allSurveys = getAllUserSurveys(session.userId);

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          const displayName = (session.userName || session.userId).replace(/[\/\\:*?"<>|]/g, '_');
          const userOutputDir = path.join(outputDir, displayName);
          if (!fs.existsSync(userOutputDir)) {
            fs.mkdirSync(userOutputDir, { recursive: true });
          }

          // å„é€±ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜
          for (let week = 1; week <= 5; week++) {
            const weekSession = allSessions[week];
            if (weekSession) {
              const survey = allSurveys[week];
              const weeklyReport = generateWeeklyReport(weekSession, survey);
              const filepath = path.join(userOutputDir, `${week}é€±ç›®.md`);
              fs.writeFileSync(filepath, weeklyReport, 'utf-8');
            }
          }

          // ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®ç·šï¼‰
          const userSummaryReport = await generateUserSummaryReport(
            session.userId, 
            session.userName || session.userId, 
            allSessions, 
            allSurveys
          );
          const userSummaryPath = path.join(userOutputDir, 'ã¾ã¨ã‚.md');
          fs.writeFileSync(userSummaryPath, userSummaryReport, 'utf-8');

          // åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆäººäº‹ç›®ç·šï¼‰
          const hrReport = await generateHRComprehensiveReport(
            session.userId, 
            session.userName || session.userId, 
            allSessions, 
            allSurveys
          );
          const hrReportPath = path.join(userOutputDir, 'åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆ.md');
          fs.writeFileSync(hrReportPath, hrReport, 'utf-8');

          console.log(`âœ… å…¨ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆå®Œäº†: ${userOutputDir}`);
          console.log(`  - 1é€±ç›®.md ã€œ 5é€±ç›®.md`);
          console.log(`  - ã¾ã¨ã‚.mdï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®ç·šï¼‰`);
          console.log(`  - åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆ.mdï¼ˆäººäº‹ç›®ç·šï¼‰`);
        } catch (hrError) {
          console.error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', hrError);
        }
      });
    }
  } catch (error) {
    console.error('OpenAI API Error:', error);
    res.status(500).json({ error: 'è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// ã‚¤ãƒ¡ãƒ¼ã‚¸ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆãªã—ã®æŠ½è±¡çš„ãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼‰
function generateImagePrompt(week, perspective, theme) {
  // ãƒ†ã‚­ã‚¹ãƒˆã‚’å«ã‚ãªã„ã€ã‚·ãƒ³ãƒ—ãƒ«ã§æ¸©ã‹ã¿ã®ã‚ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«
  const baseStyle = "Soft, warm, minimalist illustration. NO TEXT, NO LABELS, NO WORDS, NO LETTERS in the image. Use only visual symbols, icons, and abstract shapes. Gentle pastel colors with professional corporate feel. Clean and peaceful atmosphere.";

  const weekPrompts = {
    1: `${baseStyle}
Create a warm illustration about personal values and self-discovery.
Visual elements (NO TEXT):
- A peaceful silhouette of a person in the center
- Soft glowing circles radiating outward like ripples
- Simple icons floating around: a heart, a plant/seedling, a sun, a home symbol
- Warm gradient background from soft orange to gentle blue
- Gentle light rays suggesting discovery and insight
Style: Warm, introspective, peaceful. Like a meditation on personal growth.`,
    
    2: `${baseStyle}
Create a cozy illustration about relaxed conversation and connection.
Visual elements (NO TEXT):
- Two simple figures sitting together in conversation
- A steaming coffee cup between them
- Soft speech bubble shapes with simple symbols inside (stars, hearts, lightbulbs)
- Warm earth tones: cream, soft brown, gentle orange
- Comfortable, cafe-like atmosphere
Style: Friendly, relaxed, inviting. Like a warm conversation with a friend.`,
    
    3: `${baseStyle}
Create an illustration showing multiple perspectives and teamwork.
Visual elements (NO TEXT):
- A central figure surrounded by 4-5 other figures in a circle
- Connecting lines or gentle arrows between figures
- Simple icons for teamwork: puzzle pieces, handshake symbol, connected dots
- Professional colors: soft blue, teal, warm gray
- Sense of connection and mutual support
Style: Collaborative, supportive, showing how others see us.`,
    
    4: `${baseStyle}
Create an illustration showing expanding perspective from individual to society.
Visual elements (NO TEXT):
- Concentric circles expanding outward (3-4 rings)
- A small figure at the center
- Simple building/city silhouettes in outer rings
- Icons suggesting purpose: compass, star, rising arrow
- Inspiring colors: soft green, sky blue, touches of gold
Style: Expansive, hopeful, showing connection to larger purpose.`,
    
    5: `${baseStyle}
Create an illustration about integration and taking first steps.
Visual elements (NO TEXT):
- Three overlapping circles (like a Venn diagram) in soft colors
- A path or stepping stones leading forward
- A figure taking a step toward a glowing horizon
- Sunrise colors: soft pink, orange, golden yellow
- Simple milestone markers along the path
Style: Hopeful, forward-looking, encouraging small steps toward goals.`
  };

  return weekPrompts[week] || weekPrompts[1];
}

// ç”»åƒã®èª¬æ˜ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆæ—¥æœ¬èªï¼‰
function getImageDescription(week, perspective, theme) {
  const descriptions = {
    1: `ã“ã®å›³ã¯ã€ŒIï¼ˆå€‹äººï¼‰ã®è¦–ç‚¹ã€ã‹ã‚‰ã€ã‚ãªãŸè‡ªèº«ã®ä¾¡å€¤è¦³ç™ºè¦‹ã®æ—…ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚ä¸­å¿ƒã«ã„ã‚‹äººç‰©ã¯ã‚ãªãŸè‡ªèº«ã‚’è¡¨ã—ã€å‘¨å›²ã«åºƒãŒã‚‹å††ã¯å¯¾è©±ã‚’é€šã˜ã¦è¦‹ã¤ã‹ã£ãŸä¾¡å€¤è¦³ï¼ˆæˆé•·ãƒ»å®¶æ—ãƒ»æŒ‘æˆ¦ãƒ»å¥åº·ãªã©ï¼‰ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚è‡ªå·±ç™ºè¦‹ã®é“ã®ã‚ŠãŒã€æ¸©ã‹ã„è‰²åˆã„ã§æã‹ã‚Œã¦ã„ã¾ã™ã€‚`,
    
    2: `ã“ã®å›³ã¯ã€Œé›‘è«‡ã¨è‡ªå·±ç™ºè¦‹ã€ã‚’ãƒ†ãƒ¼ãƒã«ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸå¯¾è©±ã®ä¸­ã‹ã‚‰ç”Ÿã¾ã‚Œã‚‹æ°—ã¥ãã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚äºŒäººã®äººç‰©ãŒå’Œã‚„ã‹ã«ä¼šè©±ã—ã¦ã„ã‚‹æ§˜å­ã¨ã€ãã“ã‹ã‚‰æµ®ã‹ã³ä¸ŠãŒã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„èˆˆå‘³ãŒæã‹ã‚Œã¦ã„ã¾ã™ã€‚ã‚³ãƒ¼ãƒ’ãƒ¼ã‚«ãƒƒãƒ—ã¯ã€ãã¤ã‚ã„ã é›°å›²æ°—ã‚’è±¡å¾´ã—ã¦ã„ã¾ã™ã€‚`,
    
    3: `ã“ã®å›³ã¯ã€ŒWEï¼ˆãƒãƒ¼ãƒ ãƒ»çµ„ç¹”ï¼‰ã®è¦–ç‚¹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚ä¸­å¿ƒã«ã„ã‚‹ã‚ãªãŸã‚’ã€ä¸Šå¸ãƒ»åŒåƒšãƒ»éƒ¨ä¸‹ãªã©æ§˜ã€…ãªç«‹å ´ã®äººã€…ãŒå–ã‚Šå›²ã¿ã€ãã‚Œãã‚Œã®è¦–ç‚¹ã‹ã‚‰ã‚ãªãŸã‚’è¦‹ã¦ã„ã¾ã™ã€‚ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®çŸ¢å°ã¯ã€å¤šè§’çš„ãªè¦–ç‚¹ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚å”åŠ›ãƒ»ä¿¡é ¼ãƒ»å½¹å‰²ãƒ»è²¢çŒ®ã¨ã„ã£ãŸè¦ç´ ãŒã€çµ„ç¹”ã®ä¸­ã§ã®ã‚ãªãŸã®å­˜åœ¨ã‚’æã„ã¦ã„ã¾ã™ã€‚`,
    
    4: `ã“ã®å›³ã¯ã€ŒSï¼ˆä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®è¦–ç‚¹ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚åŒå¿ƒå††çŠ¶ã«åºƒãŒã‚‹æ§‹é€ ã¯ã€å€‹äººâ†’ãƒãƒ¼ãƒ â†’ä¼šç¤¾â†’ç¤¾ä¼šã¨ã„ã†è¦–åº§ã®åºƒãŒã‚Šã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ä¸­å¿ƒã«ã„ã‚‹ã‚ãªãŸãŒã€ã‚ˆã‚Šå¤§ããªç›®çš„ã‚„ä½¿å‘½ã¨ã¤ãªãŒã£ã¦ã„ã‚‹æ§˜å­ãŒã€çŸ¢å°ã§è¡¨ç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³ãƒ»ç¤¾ä¼šè²¢çŒ®ã¨ã„ã£ãŸè¦ç´ ãŒæã‹ã‚Œã¦ã„ã¾ã™ã€‚`,
    
    5: `ã“ã®å›³ã¯ã€Œçµ±åˆã¨è¡Œå‹•è¨ˆç”»ã€ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚Iãƒ»WEãƒ»Sã®3ã¤ã®å††ãŒä¸€ã¤ã«é‡ãªã‚Šåˆã„ã€ã“ã‚Œã¾ã§ã®æ°—ã¥ããŒçµ±åˆã•ã‚Œã¦ã„ã‚‹æ§˜å­ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ç›®æ¨™ã«å‘ã‹ã£ã¦ä¼¸ã³ã‚‹é“ã¨ã€æœ€åˆã®ä¸€æ­©ã‚’è¸ã¿å‡ºã™äººç‰©ãŒã€å¸Œæœ›ã«æº€ã¡ãŸæœç„¼ã‘ã®è‰²ã§æã‹ã‚Œã¦ã„ã¾ã™ã€‚å°ã•ãªä¸€æ­©ã®å¤§åˆ‡ã•ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚`
  };

  return descriptions[week] || descriptions[1];
}

// ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã™ã‚‹é–¢æ•°
async function downloadAndSaveImage(imageUrl, sessionId) {
  return new Promise((resolve, reject) => {
    const filename = `session_${sessionId}_${Date.now()}.png`;
    const filepath = path.join(imagesDir, filename);
    const file = fs.createWriteStream(filepath);

    https.get(imageUrl, (response) => {
      // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«å¯¾å¿œ
      if (response.statusCode === 301 || response.statusCode === 302) {
        https.get(response.headers.location, (redirectedResponse) => {
          redirectedResponse.pipe(file);
          file.on('finish', () => {
            file.close();
            resolve(`/images/${filename}`);
          });
        }).on('error', (err) => {
          fs.unlink(filepath, () => { }); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          reject(err);
        });
      } else {
        response.pipe(file);
        file.on('finish', () => {
          file.close();
          resolve(`/images/${filename}`);
        }).on('error', (err) => {
          fs.unlink(filepath, () => { }); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          reject(err);
        });
      }
    }).on('error', (err) => {
      fs.unlink(filepath, () => { }); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
      reject(err);
    });
  });
}

// å è¡“ä¸€è¦§å–å¾—
app.get('/api/fortune-types', (req, res) => {
  res.json(fortuneTypes);
});

// å è¡“è¨­å®šï¼ˆè¤‡æ•°å¯¾å¿œï¼‰
app.post('/api/session/set-fortune', (req, res) => {
  const { sessionId, fortuneTypes: selectedFortunes } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  // è¤‡æ•°ã®å è¡“ã«å¯¾å¿œ
  const fortuneArray = Array.isArray(selectedFortunes) ? selectedFortunes : [selectedFortunes];

  // å„å è¡“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿½åŠ 
  fortuneArray.forEach(fortuneType => {
    const fortunePrompt = getFortunePrompt(fortuneType, {
      userName: session.userName
    });

    session.messages.push({
      role: 'system',
      content: fortunePrompt
    });
  });

  session.fortuneTypes = fortuneArray;
  saveSessionToFile(sessionId, session);

  res.json({ success: true, selectedFortunes: fortuneArray });
});

// ãŠä»»ã›å ã„
app.post('/api/session/omakase-fortune', async (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  // AIã«å è¡“ã‚’é¸ã‚“ã§ã‚‚ã‚‰ã†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
  const omakasePrompt = `
ã€ãŠä»»ã›å ã„ãƒ¢ãƒ¼ãƒ‰ã€‘

å‚åŠ è€…ãŒã€ŒãŠä»»ã›å ã„ã€ã‚’é¸ã³ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®å è¡“ã®ä¸­ã‹ã‚‰ã€ã“ã‚Œã¾ã§ã®å¯¾è©±ã‚„å‚åŠ è€…ã®çŠ¶æ³ã‚’è¸ã¾ãˆã¦ã€
æœ€ã‚‚é©åˆ‡ã ã¨æ€ã‚ã‚Œã‚‹2ã€œ3ç¨®é¡ã®å è¡“ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚

åˆ©ç”¨å¯èƒ½ãªå è¡“:
${Object.entries(fortuneTypes).map(([key, name]) => `- ${name}`).join('\n')}

é¸ã‚“ã å è¡“ã¨ãã®ç†ç”±ã‚’ç°¡æ½”ã«èª¬æ˜ã—ã¦ã‹ã‚‰ã€å ã„ã‚’å§‹ã‚ã¦ãã ã•ã„ã€‚
ä¾‹: ã€Œã‚ãªãŸã«ã¯è¥¿æ´‹å æ˜Ÿè¡“ã¨ã‚¿ãƒ­ãƒƒãƒˆå ã„ãŒè‰¯ã•ãã†ã§ã™ã€‚ãªãœãªã‚‰...ã€
`;

  session.messages.push({
    role: 'system',
    content: omakasePrompt
  });

  session.fortuneMode = 'omakase';
  saveSessionToFile(sessionId, session);

  res.json({ success: true, mode: 'omakase' });
});

// æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
app.get('/api/session/check/:userId/:week', (req, res) => {
  const { userId, week } = req.params;

  const existingSession = findUserWeekSessions(userId, parseInt(week));

  if (existingSession) {
    res.json({
      exists: true,
      sessionId: existingSession.sessionId,
      week: existingSession.week,
      theme: existingSession.theme,
      conversationMode: existingSession.conversationMode,
      sessionLength: existingSession.sessionLength,
      messageCount: existingSession.messages.length - 1,
      createdAt: existingSession.createdAt,
      lastSavedAt: existingSession.lastSavedAt
    });
  } else {
    res.json({ exists: false });
  }
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹
app.post('/api/session/resume', (req, res) => {
  const { sessionId } = req.body;

  // ãƒ¡ãƒ¢ãƒªã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
  let session = sessions.get(sessionId);

  // ãƒ¡ãƒ¢ãƒªã«ãªã‘ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
  if (!session) {
    session = loadSessionFromFile(sessionId);
    if (session) {
      sessions.set(sessionId, session);
    }
  }

  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  res.json({
    sessionId: session.sessionId,
    week: session.week,
    theme: session.theme,
    perspective: session.perspective,
    article: session.article,
    summary: session.summary,
    completedAt: session.completedAt,
    imageUrl: session.imageUrl,
    sessionId: session.sessionId
  });
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³æ‰‹å‹•ä¿å­˜
app.post('/api/session/save', (req, res) => {
  const { sessionId } = req.body;

  const session = sessions.get(sessionId);
  if (!session) {
    return res.status(404).json({ error: 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
  }

  saveSessionToFile(sessionId, session);

  res.json({
    success: true,
    lastSavedAt: new Date().toISOString()
  });
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§å–å¾—
app.get('/api/sessions/:userId', (req, res) => {
  const { userId } = req.params;

  const userSessions = Array.from(sessions.entries())
    .filter(([key]) => key.startsWith(userId))
    .map(([, value]) => ({
      sessionId: value.sessionId,
      week: value.week,
      theme: value.theme,
      createdAt: value.createdAt,
      summary: value.summary,
      messageCount: value.messages.length - 1
    }));

  res.json(userSessions);
});

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
app.get('/api/session/report/:userId/:week', (req, res) => {
  const { userId, week } = req.params;
  const weekNum = parseInt(week, 10);

  console.log(`Report requested: userId=${userId}, week=${weekNum}`);

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å®Œäº†ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
  const session = findUserWeekSessions(userId, weekNum);

  if (!session) {
    console.log('Session not found in files, checking memory...');
    // ãƒ¡ãƒ¢ãƒªã‹ã‚‰ã‚‚æ¤œç´¢
    const memorySession = Array.from(sessions.values()).find(
      s => s.userId === userId && s.week === weekNum && s.isCompleted
    );
    
    if (!memorySession) {
      return res.status(404).json({ error: 'ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' });
    }
    
    return res.json({
      article: memorySession.article,
      summary: memorySession.summary,
      theme: memorySession.theme,
      week: memorySession.week,
      imageUrl: memorySession.imageUrl,
      completedAt: memorySession.completedAt
    });
  }

  // å®Œäº†ã—ã¦ã„ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å ´åˆ
  if (!session.isCompleted || !session.article) {
    return res.status(404).json({ error: 'ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“' });
  }

  res.json({
    article: session.article,
    summary: session.summary,
    theme: session.theme,
    week: session.week,
    imageUrl: session.imageUrl,
    completedAt: session.completedAt
  });
});

// ========================================
// äººäº‹å‘ã‘è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›æ©Ÿèƒ½
// ========================================

// ã‚·ãƒŠãƒªã‚ªãƒ¡ãƒ¢ã«åŸºã¥ãé€±ã”ã¨ã®è¨­å®š
// â€»ã‚·ãƒŠãƒªã‚ªã¯4é€±æ§‹æˆã ãŒã€1é€±ç›®ã¨2é€±ç›®ã®é–“ã«é›‘è«‡ä¼šã‚’å…¥ã‚ŒãŸãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¯5é€±æ§‹æˆ
// ã‚·ã‚¹ãƒ†ãƒ 1é€±ç›® = ã‚·ãƒŠãƒªã‚ª1é€±ç›®ï¼ˆIï¼‰
// ã‚·ã‚¹ãƒ†ãƒ 2é€±ç›® = é›‘è«‡ä¼šï¼ˆè¿½åŠ ï¼‰
// ã‚·ã‚¹ãƒ†ãƒ 3é€±ç›® = ã‚·ãƒŠãƒªã‚ª2é€±ç›®ï¼ˆWE - éƒ¨ç½²ï¼‰
// ã‚·ã‚¹ãƒ†ãƒ 4é€±ç›® = ã‚·ãƒŠãƒªã‚ª3é€±ç›®ï¼ˆS - PERSOLã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
// ã‚·ã‚¹ãƒ†ãƒ 5é€±ç›® = ã‚·ãƒŠãƒªã‚ª4é€±ç›®ï¼ˆçµ±åˆï¼‰
const weeklyScenario = {
  1: {
    timing: '1é€±ç›®',
    scenarioWeek: '1é€±ç›®',
    scope: 'I',
    scopeLabel: 'å€‹äºº',
    purpose: 'å€‹äººã®ä¾¡å€¤è¦³ã®æ¢æ±‚ã€è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹',
    goal: 'ã€Œä¾¡å€¤è¦³ã€ã‚’èµ·ç‚¹ã«ã—ãŸè‡ªå·±ç†è§£ãŒæ·±ã¾ã£ãŸçŠ¶æ…‹',
    keyPoints: [
      'ãã®äººã®ã‚ã‚Šã®ã¾ã¾ã®ä¾¡å€¤è¦³ã‚’å—å®¹ã™ã‚‹è¨­è¨ˆ',
      'ãã®äººã‚‰ã—ã„ã€Œã¯ãŸã‚‰ãWell-beingã€ã‚’å¼•ãå‡ºã™',
      'ç´å¾—æ„Ÿã€è…¹è½ã¡æ„Ÿã‚’å¤§åˆ‡ã«',
      'ã©ã‚“ãªIã§ã‚‚å—å®¹ã€æœ¬éŸ³ã‚’è©±ã—ã¦ã‚‚ã„ã„ã‚“ã ã¨æ€ã£ã¦ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ãªAI'
    ],
    dialogueFlow: [
      'AIã‹ã‚‰ã®ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¶£æ—¨ã‚„ãƒ«ãƒ¼ãƒ«ï¼‰',
      'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ï¼šç¾åœ¨ã€Œã¯ãŸã‚‰ãWell-beingã€ã®ãƒ¯ãƒ¼ã‚¯ã‚’å®Ÿæ–½ã™ã‚‹ä»Šã®æ°—æŒã¡',
      'ã¯ãŸã‚‰ãã†ãˆã§å¤§äº‹ã«ã—ã¦ã„ã‚‹ã€Œä¾¡å€¤è¦³ã€TOP3',
      'ãã‚Œãã‚Œã«ã¤ã„ã¦é¸ã‚“ã èƒŒæ™¯ã€ç†ç”±ï¼ˆæ·±å €ã‚Šï¼‰',
      'è‡ªåˆ†ã®ä¸­ã«ã‚ã‚‹èƒŒæ™¯ã‚„ä¾¡å€¤è¦³ã«å¯¾ã™ã‚‹è‡ªå·±ç†è§£',
      'é•ã†è¦–ç‚¹ã€é•ã†è¡¨ç¾ã§è¨€ã„æ›ãˆæ°—ã¥ãã‚’ä¸ãˆã‚‹',
      'ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šä»Šæ—¥ã®å¯¾è©±ã‹ã‚‰ã®æ°—ã¥ãã€æ„Ÿã˜ãŸã“ã¨',
      'æ¬¡å›ã®ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³'
    ]
  },
  2: {
    timing: '2é€±ç›®',
    scenarioWeek: 'ï¼ˆè¿½åŠ ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰',
    scope: 'Chat',
    scopeLabel: 'é›‘è«‡ä¼š',
    purpose: 'Week 1ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†ã¨ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸå¯¾è©±',
    goal: 'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦è©±ã›ã€æ¬¡å›ä»¥é™ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ˆã‚Šè‰¯ã„ã‚‚ã®ã«ãªã‚‹ã“ã¨',
    keyPoints: [
      'å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ„Ÿæƒ³ã‚„æ”¹å–„ç‚¹ã‚’èã',
      'è¶£å‘³ã€èˆˆå‘³ã€æ‚©ã¿ãªã©ã€ãã®äººã‚’ã‚ˆã‚Šæ·±ãçŸ¥ã‚‹',
      'å ã„ãƒ¢ãƒ¼ãƒ‰ã§è‡ªå·±ç†è§£ã‚’æ·±ã‚ã‚‹ï¼ˆå¸Œæœ›æ™‚ï¼‰',
      'æ°—è»½ã«è©±ã›ã‚‹é›°å›²æ°—ã‚’ä½œã‚‹'
    ],
    dialogueFlow: [
      'é›‘è«‡ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯å ã„ãƒ¢ãƒ¼ãƒ‰ã®é¸æŠ',
      'Week 1ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†',
      'è¶£å‘³ãƒ»èˆˆå‘³ãƒ»æ‚©ã¿ãªã©ã®å¯¾è©±',
      'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã§ã®äº¤æµ'
    ]
  },
  3: {
    timing: '3é€±ç›®',
    scenarioWeek: '2é€±ç›®',
    scope: 'WE',
    scopeLabel: 'çµ„ç¹”ï¼ˆéƒ¨ç½²ï¼‰',
    purpose: 'çµ„ç¹”ï¼ˆéƒ¨ç½²ï¼‰ã¨ã€Œç§ã€ã®é–¢ã‚ã‚Šã®æ¢æ±‚ã€è§£åƒåº¦å‘ä¸Š',
    goal: 'çµ„ç¹”ï¼ˆéƒ¨ç½²ï¼‰ã®ä»•äº‹ã®æ„ç¾©ã€ä¾¡å€¤ã¨ã€è‡ªåˆ†ãŒã¯ãŸã‚‰ãã†ãˆã§æˆã—é‚ã’ãŸã„ã“ã¨ã®é‡ãªã‚Šã«ã¤ã„ã¦ã€è§£åƒåº¦ãŒé«˜ã¾ã£ãŸçŠ¶æ…‹',
    keyPoints: [
      'æœ¬äººãŒæœ¬éŸ³ã‚’è©±ã›ã‚‹è¨­è¨ˆï¼ˆMBOã§ã¯ãªã„ï¼‰',
      'é‡ãªã‚ŠãŒã‚ã¾ã‚Šãªã„ã¨ãã‚‚ã€ãªãœé‡ãªã‚Šåˆã‚ãªã„ã®ã‹æ¢æ±‚',
      'AIã®åŠ©è¨€ã‚„å•ã„ã‹ã‘ã«ã‚ˆã‚Šæ–°ãŸãªè¦–ç‚¹ã§ç‰©äº‹ã‚’è¦‹ã‚‹',
      'ã‚ˆã„å•ã„ã§ã‚ã‚Œã°ã€é ­ã«æ®‹ã‚Šã€æŒã¡å¸°ã£ã¦è€ƒãˆã‚‹'
    ],
    dialogueFlow: [
      'å‰å›ã®æŒ¯ã‚Šè¿”ã‚Šï¼ˆä¼šè©±å†…å®¹ã®ã‚µãƒãƒªï¼†å‰å›ã®ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼‰',
      'AIã‹ã‚‰ä»Šæ—¥ã®ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³',
      'ã‚ãªãŸã®éƒ¨ç½²ã¯ä½•ã‚’ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«ã€èª°ã«ã©ã‚“ãªä¾¡å€¤ã‚’æä¾›ã—ã¦ã„ã‚‹çµ„ç¹”ã‹',
      'éƒ¨ç½²ãŒå¤§äº‹ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³TOP3',
      'ãã‚Œãã‚Œã«ã¤ã„ã¦é¸ã‚“ã èƒŒæ™¯ã€ç†ç”±ï¼ˆæ·±å €ã‚Šï¼‰',
      'è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨é‡ãªã‚‹ã¨ã“ã‚ã¯ã‚ã‚‹ã‹ã€ãã‚Œã¯ãªãœã‹',
      'AIã‹ã‚‰ã®ææ¡ˆï¼ˆã†ã¾ãå¯¾è©±ãŒã§ããªã„ã¨ãï¼‰',
      'ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šä»Šæ—¥ã®å¯¾è©±ã‹ã‚‰ã®æ°—ã¥ãã€æ„Ÿã˜ãŸã“ã¨',
      'æ¬¡å›ã®ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³'
    ]
  },
  4: {
    timing: '4é€±ç›®',
    scenarioWeek: '3é€±ç›®',
    scope: 'S',
    scopeLabel: 'çµ„ç¹”ï¼ˆPERSOLã‚°ãƒ«ãƒ¼ãƒ—ï¼‰',
    purpose: 'çµ„ç¹”ï¼ˆPERSOLã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã¨ã€Œç§ã€ã®é–¢ã‚ã‚Šã®æ¢æ±‚ã€è§£åƒåº¦å‘ä¸Š',
    goal: 'PERSOLã‚°ãƒ«ãƒ¼ãƒ—ã®ä»•äº‹ã®æ„ç¾©ã€ä¾¡å€¤ã¨ã€è‡ªåˆ†ãŒã¯ãŸã‚‰ãã†ãˆã§æˆã—é‚ã’ãŸã„ã“ã¨ã®é‡ãªã‚Šã«ã¤ã„ã¦ã€è§£åƒåº¦ãŒé«˜ã¾ã£ãŸçŠ¶æ…‹',
    keyPoints: [
      'ãã®äººãªã‚Šã®PERSOLã®ä¾¡å€¤ã®è¨€èªåŒ–ã€æŒè«–ã‚’å¼•ãå‡ºã™',
      'AIã«ã‚ˆã‚‹åŠ©è¨€ã€è¦–ç‚¹ã®å…±æœ‰ã«ã‚ˆã‚Šè¨€èªåŒ–ã‚’æ”¯æ´',
      'PERSOLäººã¨ã—ã¦ä½•ã‚‰ã‹ã®è¨€èªåŒ–ãŒã§ãã‚‹ã‚ˆã†ã«',
      'PERSOLã®ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«æƒ…å ±ï¼ˆçµ±åˆå ±å‘Šæ›¸ã€äººçš„è³‡æœ¬ãƒ¬ãƒãƒ¼ãƒˆã€ä¸­è¨ˆç­‰ï¼‰ã‚’å‚ç…§'
    ],
    dialogueFlow: [
      'å‰å›ã®æŒ¯ã‚Šè¿”ã‚Šï¼ˆä¼šè©±å†…å®¹ã®ã‚µãƒãƒªï¼†å‰å›ã®ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼‰',
      'AIã‹ã‚‰ä»Šæ—¥ã®ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³',
      'PERSOLï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ï¼‰ã¯ä½•ã‚’ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«ã€èª°ã«ã©ã‚“ãªä¾¡å€¤ã‚’æä¾›ã—ã¦ã„ã‚‹çµ„ç¹”ã‹',
      'PERSOLãŒå¤§äº‹ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³TOP3',
      'ãã‚Œãã‚Œã«ã¤ã„ã¦é¸ã‚“ã èƒŒæ™¯ã€ç†ç”±ï¼ˆæ·±å €ã‚Šï¼‰',
      'è‡ªåˆ†ã®ä¾¡å€¤è¦³ã¨é‡ãªã‚‹ã¨ã“ã‚ã¯ã‚ã‚‹ã‹ã€ãã‚Œã¯ãªãœã‹',
      'AIã‹ã‚‰ã®ææ¡ˆï¼ˆã†ã¾ãå¯¾è©±ãŒã§ããªã„ã¨ãï¼‰',
      'ãƒªãƒ•ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼šä»Šæ—¥ã®å¯¾è©±ã‹ã‚‰ã®æ°—ã¥ãã€æ„Ÿã˜ãŸã“ã¨',
      'æ¬¡å›ã®ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³'
    ]
  },
  5: {
    timing: '5é€±ç›®',
    scenarioWeek: '4é€±ç›®',
    scope: 'çµ±åˆ',
    scopeLabel: 'I/WE/Sçµ±åˆ',
    purpose: 'Iã¨WEã¨Sã®çµ±åˆã«ã‚ˆã‚Šã€è‡ªèº«ãŠã‚ˆã³PERSOLã§ã¯ãŸã‚‰ãã“ã¨ã®æ„ç¾©ã‚„ä¾¡å€¤ã«ã¤ã„ã¦ç†è§£ã‚’æ·±ã‚ã‚‹',
    goal: 'ã¯ãŸã‚‰ãè‡ªåˆ†è‡ªèº«ã®ã“ã¨ã€PERSOLã§ã¯ãŸã‚‰ãã“ã¨ã®è‡ªåˆ†ãªã‚Šã®æ„ç¾©ã‚„ä¾¡å€¤ã«ã¤ã„ã¦ã€å†…çœã®æ·±ã¾ã‚Šã‚’å®Ÿæ„Ÿã§ããŸçŠ¶æ…‹ã€‚è¨€èªåŒ–ã—ãŸã‚‚ã®ã®è§£åƒåº¦ãŒé«˜ã¾ã£ã¦ã„ã‚‹çŠ¶æ…‹',
    keyPoints: [
      'æ—¥å¸¸ã¸ã®æ¥ç¶šã¾ã§å¯¾è©±ã™ã‚‹',
      'Day1ï½3ã®ã¾ã¨ã‚ã€ã‚µãƒãƒªãƒ¼ã®æç¤º',
      'è‡ªåˆ†ãŒã¯ãŸã‚‰ãã†ãˆã§å¤§äº‹ã«ã—ãŸã„ä¾¡å€¤è¦³ã®å†ç¢ºèª',
      'ä»Šæ—¥ã®ç­”ãˆã¯Î²ç‰ˆã€è€ƒãˆç¶šã‘ã¦ã»ã—ã„'
    ],
    dialogueFlow: [
      'AIã«ã‚ˆã‚‹Day1ï½3ã®ã¾ã¨ã‚ã€ã‚µãƒãƒªãƒ¼ã®æç¤º',
      'æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¦ã©ã†æ€ã†ã‹ï¼Ÿæ°—ã¥ã„ãŸã“ã¨ã€æ„Ÿã˜ãŸã“ã¨',
      'æ”¹ã‚ã¦ã€è‡ªåˆ†ãŒã¯ãŸã‚‰ãã†ãˆã§å¤§äº‹ã«ã—ãŸã„ä¾¡å€¤è¦³TOP3ï¼ˆDay1ã‹ã‚‰å¤‰æ›´OKï¼‰',
      'ãã‚Œãã‚Œã«ã¤ã„ã¦é¸ã‚“ã èƒŒæ™¯ã€ç†ç”±ï¼ˆå¤‰ã‚ã£ãŸç†ç”±ã€å¤‰ã‚ã‚‰ãªã‹ã£ãŸç†ç”±ï¼‰',
      'ã€ŒPERSOLã§å®Ÿç¾ã—ãŸã„ã€ã‚ãªãŸã®ã¯ãŸã‚‰ãWell-Beingã€ã‚’è¨€èªåŒ–ï¼ˆä»–è€…ã«èª¬æ˜ã™ã‚‹ã¤ã‚‚ã‚Šã§ï¼‰',
      'ã“ã‚Œã‹ã‚‰ã®æ—¥å¸¸ã§ã©ã®ã‚ˆã†ã«æ„è­˜ã€è¡Œå‹•ã—ã¦ã„ããŸã„ã‹',
      'AIã‹ã‚‰ã®ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ„Ÿè¬ã€Î²ç‰ˆã¨ã—ã¦è€ƒãˆç¶šã‘ã‚‹ã“ã¨ã€ãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦ï¼‰'
    ],
    output: 'çµ±åˆãƒ¬ãƒãƒ¼ãƒˆï¼ˆAIãªã‚Šã«ã¾ã¨ã‚ãŸã€ŒXXã•ã‚“ã®ã¯ãŸã‚‰ãWell-beingã€ã‚„ã€Œã‚ãªãŸã¨ç¾åœ¨ã®çµ„ç¹”ã®ã‹ã‹ã‚ã‚Šã€ã‹ã•ãªã‚Šã€ã€Œã‚ãªãŸã¨PERSOLã®ã‹ã‹ã‚ã‚Šã€ã‹ã•ãªã‚Šã€ãªã©ã®ã‚µãƒãƒªã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼‰'
  }
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
function getAllUserSessions(userId) {
  const userSessions = {};
  for (let week = 1; week <= 5; week++) {
    const session = findUserWeekSessions(userId, week);
    if (session && session.isCompleted) {
      userSessions[week] = session;
    }
  }
  return userSessions;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœã‚’å–å¾—
function getAllUserSurveys(userId) {
  const surveysDir = path.join(__dirname, 'data', 'surveys');
  if (!fs.existsSync(surveysDir)) return {};

  const userSurveys = {};
  try {
    const files = fs.readdirSync(surveysDir);
    for (let week = 1; week <= 5; week++) {
      const pattern = `survey_${userId}_week${week}_`;
      const matchingFiles = files.filter(f => f.startsWith(pattern) && f.endsWith('.json'));
      if (matchingFiles.length > 0) {
        const sortedFiles = matchingFiles.sort().reverse();
        const filepath = path.join(surveysDir, sortedFiles[0]);
        const data = fs.readFileSync(filepath, 'utf-8');
        userSurveys[week] = JSON.parse(data);
      }
    }
  } catch (error) {
    console.error('Survey collection error:', error);
  }
  return userSurveys;
}

// é€±ã”ã¨ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆã‚·ãƒŠãƒªã‚ªãƒ¡ãƒ¢ã«åŸºã¥ãï¼‰
function generateWeeklyReport(session, survey) {
  const scenario = weeklyScenario[session.week] || {};
  
  let report = `# ${session.week}é€±ç›® ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ\n\n`;
  
  // ã‚·ãƒŠãƒªã‚ªæƒ…å ±
  report += `## ğŸ“‹ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦\n\n`;
  report += `| é …ç›® | å†…å®¹ |\n|---|---|\n`;
  report += `| **ã‚·ã‚¹ãƒ†ãƒ é€±** | ${session.week}é€±ç›® |\n`;
  if (scenario.scenarioWeek) {
    report += `| **ã‚·ãƒŠãƒªã‚ªé€±** | ${scenario.scenarioWeek} |\n`;
  }
  report += `| **ãƒ†ãƒ¼ãƒ** | ${session.theme} |\n`;
  report += `| **è¦–ç‚¹ï¼ˆç¯„å›²ï¼‰** | ${scenario.scope || session.perspective}ï¼ˆ${scenario.scopeLabel || ''}ï¼‰ |\n`;
  report += `| **ç›®çš„** | ${scenario.purpose || '-'} |\n`;
  report += `| **ã‚´ãƒ¼ãƒ«** | ${scenario.goal || '-'} |\n`;
  report += `| **å®Ÿæ–½æ—¥æ™‚** | ${new Date(session.completedAt).toLocaleString('ja-JP')} |\n`;
  report += `| **ä¼šè©±ãƒ¢ãƒ¼ãƒ‰** | ${session.conversationMode || 'standard'} |\n`;
  report += `| **ã‚»ãƒƒã‚·ãƒ§ãƒ³é•·ã•** | ${session.sessionLength || 'medium'} |\n\n`;

  // é€±ã®ãƒã‚¤ãƒ³ãƒˆ
  if (scenario.keyPoints && scenario.keyPoints.length > 0) {
    report += `### ğŸ¯ ã“ã®é€±ã§å¤§äº‹ã«ã—ã¦ã„ã‚‹ã“ã¨\n`;
    scenario.keyPoints.forEach(point => {
      report += `- ${point}\n`;
    });
    report += '\n';
  }

  // å¯¾è©±ã®æµã‚Œ
  if (scenario.dialogueFlow && scenario.dialogueFlow.length > 0) {
    report += `### ğŸ“ å¯¾è©±ã®æµã‚Œï¼ˆã‚·ãƒŠãƒªã‚ªï¼‰\n`;
    scenario.dialogueFlow.forEach((step, i) => {
      report += `${i + 1}. ${step}\n`;
    });
    report += '\n';
  }

  report += `---\n\n`;

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®è¨˜äº‹å†…å®¹
  report += `## ğŸ“– ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²\n\n`;
  if (session.article) {
    report += session.article;
    report += '\n\n';
  }

  report += `---\n\n`;

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ
  report += `## ğŸ“Š ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆçµæœ\n\n`;
  if (survey && survey.responses) {
    const r = survey.responses;
    const scoreLabels = { 1: 'â­', 2: 'â­â­', 3: 'â­â­â­', 4: 'â­â­â­â­', 5: 'â­â­â­â­â­' };
    
    if (r.satisfaction) {
      report += `| é …ç›® | è©•ä¾¡ |\n|---|---|\n`;
      report += `| æº€è¶³åº¦ | ${scoreLabels[r.satisfaction] || r.satisfaction}/5 |\n`;
      if (r.awareness) report += `| æ°—ã¥ã | ${scoreLabels[r.awareness] || r.awareness}/5 |\n`;
      if (r.ease) report += `| è©±ã—ã‚„ã™ã• | ${scoreLabels[r.ease] || r.ease}/5 |\n`;
      if (r.motivation) report += `| æ¬¡å›ã¸ã®æ„æ¬² | ${scoreLabels[r.motivation] || r.motivation}/5 |\n`;
      report += '\n';
    }
    if (r.feedback) {
      report += `**å‚åŠ è€…ã‚³ãƒ¡ãƒ³ãƒˆ**:\n> ${r.feedback}\n\n`;
    }
  } else {
    report += `_ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæœªå›ç­”_\n\n`;
  }

  // ã‚´ãƒ¼ãƒ«é”æˆåº¦ã®è©•ä¾¡ï¼ˆã‚ã‚Œã°ï¼‰
  if (scenario.goal && survey?.responses?.awareness) {
    report += `### ğŸ¯ ã‚´ãƒ¼ãƒ«é”æˆã¸ã®è©•ä¾¡\n`;
    const achievementLevel = survey.responses.awareness >= 4 ? 'é”æˆã«å‘ã‘ã¦è‰¯å¥½' : 
                             survey.responses.awareness >= 3 ? 'æ¦‚ã­é€²æ—ã‚ã‚Š' : 'æ›´ãªã‚‹æ·±å €ã‚ŠãŒæœ›ã¾ã—ã„';
    report += `**${scenario.goal}**\n`;
    report += `â†’ è©•ä¾¡: ${achievementLevel}\n\n`;
  }

  return report;
}

// ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®ç·š - æ¸©ã‹ãã€è‡ªåˆ†ã¸ã®æŒ¯ã‚Šè¿”ã‚Šã«ä½¿ãˆã‚‹å½¢å¼ï¼‰
async function generateUserSummaryReport(userId, userName, allSessions, allSurveys) {
  let report = `# ğŸŒŸ ${userName}ã•ã‚“ã®ã€Œã¯ãŸã‚‰ãWell-beingã€ã®æ—…è·¯\n\n`;
  report += `> ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ã€ã‚ãªãŸè‡ªèº«ã®ä¾¡å€¤è¦³ã‚„æƒ³ã„ã‚’æŒ¯ã‚Šè¿”ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚\n`;
  report += `> ã„ã¤ã§ã‚‚èª­ã¿è¿”ã—ã¦ã€è‡ªåˆ†ã‚’è¦‹ã¤ã‚ç›´ã™ãã£ã‹ã‘ã«ã—ã¦ãã ã•ã„ã€‚\n\n`;
  report += `**ä½œæˆæ—¥**: ${new Date().toLocaleString('ja-JP')}\n\n`;

  report += `---\n\n`;

  // ãƒ—ãƒ­ã‚°ãƒ©ãƒ å…¨ä½“ã®æµã‚Œ
  report += `## ğŸ“… ã‚ãªãŸã®æ­©ã¿\n\n`;
  
  for (let week = 1; week <= 5; week++) {
    const session = allSessions[week];
    const scenario = weeklyScenario[week];
    const survey = allSurveys[week];
    
    if (session) {
      report += `### ğŸ”¹ ${week}é€±ç›®: ${scenario?.scopeLabel || session.theme}\n`;
      report += `**ãƒ†ãƒ¼ãƒ**: ${session.theme}\n`;
      report += `**ç›®çš„**: ${scenario?.purpose || '-'}\n\n`;
      if (session.summary) {
        report += `${session.summary}\n\n`;
      }
    } else {
      report += `### â—»ï¸ ${week}é€±ç›®: ${scenario?.scopeLabel || 'æœªå®Ÿæ–½'}\n`;
      report += `_ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯ã¾ã å®Ÿæ–½ã•ã‚Œã¦ã„ã¾ã›ã‚“_\n\n`;
    }
  }

  report += `---\n\n`;

  // I/WE/Såˆ†æï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®æ¸©ã‹ã„ãƒˆãƒ¼ãƒ³ï¼‰
  if (Object.keys(allSessions).length >= 2) {
    report += `## ğŸ’¡ ã‚ãªãŸã®ä¾¡å€¤è¦³ãƒãƒƒãƒ—\n\n`;
    report += `ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é€šã˜ã¦è¦‹ãˆã¦ããŸã€ã‚ãªãŸã®å¤§åˆ‡ãªã‚‚ã®ã‚’æ•´ç†ã—ã¾ã—ãŸã€‚\n\n`;
    
    const summaries = Object.values(allSessions)
      .filter(s => s.summary)
      .map(s => `${s.week}é€±ç›®ï¼ˆ${weeklyScenario[s.week]?.scopeLabel || ''}ï¼‰: ${s.summary}`)
      .join('\n');

    try {
      const analysisCompletion = await openai.chat.completions.create({
        model: 'gpt-4',
        messages: [
          {
            role: 'system',
            content: `ã‚ãªãŸã¯æ¸©ã‹ãå…±æ„Ÿçš„ãªã‚³ãƒ¼ãƒã§ã™ã€‚å‚åŠ è€…æœ¬äººãŒèª­ã‚“ã§å¬‰ã—ããªã‚Šã€è‡ªå·±ç†è§£ãŒæ·±ã¾ã‚‹ã‚ˆã†ãªæŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
ã€Œã‚ãªãŸã¯ã€œã€ã¨ã„ã†äºŒäººç§°ã§ã€è¦ªã—ã¿ã‚„ã™ãåŠ±ã¾ã—ã®ãƒˆãƒ¼ãƒ³ã§æ›¸ã„ã¦ãã ã•ã„ã€‚`
          },
          {
            role: 'user',
            content: `ä»¥ä¸‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚µãƒãƒªãƒ¼ã‹ã‚‰ã€å‚åŠ è€…æœ¬äººå‘ã‘ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

${summaries}

ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

### ğŸ§¡ ã‚ãªãŸãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã“ã¨ï¼ˆIï¼šå€‹äººã®ä¾¡å€¤è¦³ï¼‰
ã‚ãªãŸè‡ªèº«ãŒä»•äº‹ã‚„äººç”Ÿã§å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³ã‚’ã€æ¸©ã‹ã„è¨€è‘‰ã§ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

### ğŸ¤ ã‚ãªãŸã¨ãƒãƒ¼ãƒ ãƒ»çµ„ç¹”ï¼ˆWEï¼šé–¢ä¿‚æ€§ï¼‰
ãƒãƒ¼ãƒ ã‚„çµ„ç¹”ã®ä¸­ã§ã‚ãªãŸãŒã©ã‚“ãªå­˜åœ¨ã§ã‚ã‚ŠãŸã„ã‹ã€ã©ã‚“ãªé–¢ã‚ã‚Šæ–¹ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã‹ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

### ğŸŒ ã‚ãªãŸã¨ä¼šç¤¾ãƒ»ç¤¾ä¼šï¼ˆSï¼šã‚ˆã‚Šå¤§ããªè¦–ç‚¹ï¼‰
ä¼šç¤¾ã‚„ç¤¾ä¼šã«å¯¾ã—ã¦ã‚ãªãŸãŒæ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã€è²¢çŒ®ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹ã“ã¨ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

### âœ¨ ã‚ãªãŸã®ã€Œã¯ãŸã‚‰ãWell-beingã€
ã“ã‚Œã‚‰ã‚’çµ±åˆã—ã¦ã€ã‚ãªãŸã«ã¨ã£ã¦ã®ã€Œã¯ãŸã‚‰ãWell-beingã€ã¨ã¯ä½•ã‹ã‚’ã€æœ¬äººã«èªã‚Šã‹ã‘ã‚‹ã‚ˆã†ã«è¡¨ç¾ã—ã¦ãã ã•ã„ã€‚

æ¸©ã‹ãã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ã€æœ¬äººãŒèª­ã‚“ã§åŠ›ã‚’ã‚‚ã‚‰ãˆã‚‹ã‚ˆã†ãªæ–‡ç« ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚`
          }
        ],
        temperature: 0.7,
        max_tokens: 1000
      });

      report += analysisCompletion.choices[0].message.content + '\n\n';
    } catch (error) {
      console.error('User summary analysis error:', error);
      report += '_åˆ†æã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ_\n\n';
    }
  }

  // ã“ã‚Œã‹ã‚‰ã®ä¸€æ­©
  report += `---\n\n`;
  report += `## ğŸš€ ã“ã‚Œã‹ã‚‰ã®ä¸€æ­©\n\n`;
  report += `ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§è¦‹ã¤ã‘ãŸä¾¡å€¤è¦³ã‚„Well-beingã‚’ã€æ—¥å¸¸ã®ä¸­ã§æ„è­˜ã—ã¦ã„ãã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚\n\n`;
  report += `- **ä»Šæ—¥ã‹ã‚‰æ„è­˜ã§ãã‚‹ã“ã¨**: ä¸€ã¤ã§ã„ã„ã®ã§ã€è‡ªåˆ†ã®ä¾¡å€¤è¦³ã‚’æ„è­˜ã™ã‚‹å ´é¢ã‚’å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†\n`;
  report += `- **å›°ã£ãŸã¨ãã¯**: ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¿”ã—ã¦ã€è‡ªåˆ†ãŒä½•ã‚’å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ã‹ã‚’æ€ã„å‡ºã—ã¾ã—ã‚‡ã†\n`;
  report += `- **ç¶šã‘ã¦ã„ãã“ã¨**: ä¾¡å€¤è¦³ã¯å¤‰åŒ–ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚å®šæœŸçš„ã«è‡ªåˆ†ã‚’æŒ¯ã‚Šè¿”ã‚‹æ™‚é–“ã‚’æŒã¡ã¾ã—ã‚‡ã†\n\n`;

  report += `---\n\n`;
  report += `> ğŸŒˆ ã‚ãªãŸã®ã€Œã¯ãŸã‚‰ãWell-beingã€ã®æ—…ã¯ã“ã‚Œã‹ã‚‰ã‚‚ç¶šãã¾ã™ã€‚\n`;
  report += `> è‡ªåˆ†ã‚‰ã—ãã€å‰å‘ãã«æ­©ã‚“ã§ã„ã£ã¦ãã ã•ã„ï¼\n\n`;
  report += `_ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸ_\n`;

  return report;
}

// äººäº‹å‘ã‘åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆï¼ˆäººäº‹ç›®ç·š - å®¢è¦³çš„ãƒ»åˆ†æçš„è¦–ç‚¹ï¼‰
async function generateHRComprehensiveReport(userId, userName, allSessions, allSurveys) {
  let report = `# åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆï¼ˆäººäº‹å‘ã‘ï¼‰\n\n`;
  report += `## å¯¾è±¡è€…æƒ…å ±\n\n`;
  report += `| é …ç›® | å†…å®¹ |\n|---|---|\n`;
  report += `| **æ°å** | ${userName} |\n`;
  report += `| **ãƒ¦ãƒ¼ã‚¶ãƒ¼ID** | ${userId} |\n`;
  report += `| **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ—¥** | ${new Date().toLocaleString('ja-JP')} |\n`;
  report += `| **ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†æ•°** | ${Object.keys(allSessions).length} / 5 é€± |\n\n`;

  report += `---\n\n`;

  // ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ¦‚è¦
  report += `## ğŸ“š ãƒ—ãƒ­ã‚°ãƒ©ãƒ æ¦‚è¦\n\n`;
  report += `æœ¬ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã€å¾“æ¥­å“¡ã®ã€Œã¯ãŸã‚‰ãWell-beingã€ã‚’æ¢æ±‚ã—ã€è‡ªå·±ç†è§£ã¨çµ„ç¹”ã¨ã®é–¢ã‚ã‚Šã‚’æ·±ã‚ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚\n\n`;
  report += `> â€»ã‚·ãƒŠãƒªã‚ªã¯4é€±æ§‹æˆã§ã™ãŒã€1é€±ç›®ã¨2é€±ç›®ã®é–“ã«é›‘è«‡ä¼šã‚’è¿½åŠ ã—ãŸãŸã‚ã€ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¯5é€±æ§‹æˆã¨ãªã£ã¦ã„ã¾ã™ã€‚\n\n`;
  report += `| ã‚·ã‚¹ãƒ†ãƒ é€± | ã‚·ãƒŠãƒªã‚ªé€± | ç¯„å›² | ç›®çš„ |\n|---|---|---|---|\n`;
  for (let week = 1; week <= 5; week++) {
    const scenario = weeklyScenario[week];
    if (scenario) {
      report += `| ${week}é€±ç›® | ${scenario.scenarioWeek} | ${scenario.scope}ï¼ˆ${scenario.scopeLabel}ï¼‰ | ${scenario.purpose} |\n`;
    }
  }
  report += '\n';

  report += `---\n\n`;

  // ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼
  report += `## ğŸ“‹ ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼\n\n`;
  
  const completedWeeks = Object.keys(allSessions).length;
  const avgSatisfaction = Object.values(allSurveys)
    .filter(s => s?.responses?.satisfaction)
    .map(s => s.responses.satisfaction)
    .reduce((a, b, _, arr) => a + b / arr.length, 0) || 0;
  
  const avgAwareness = Object.values(allSurveys)
    .filter(s => s?.responses?.awareness)
    .map(s => s.responses.awareness)
    .reduce((a, b, _, arr) => a + b / arr.length, 0) || 0;

  report += `| æŒ‡æ¨™ | å€¤ | è©•ä¾¡ |\n|---|---|---|\n`;
  report += `| ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œäº†ç‡ | ${(completedWeeks / 5 * 100).toFixed(0)}% | ${completedWeeks === 5 ? 'âœ… å®Œäº†' : 'âš ï¸ é€²è¡Œä¸­'} |\n`;
  report += `| å¹³å‡æº€è¶³åº¦ | ${avgSatisfaction.toFixed(1)} / 5 | ${avgSatisfaction >= 4 ? 'è‰¯å¥½' : avgSatisfaction >= 3 ? 'æ™®é€š' : 'è¦æ³¨æ„'} |\n`;
  report += `| å¹³å‡æ°—ã¥ãåº¦ | ${avgAwareness.toFixed(1)} / 5 | ${avgAwareness >= 4 ? 'è‰¯å¥½' : avgAwareness >= 3 ? 'æ™®é€š' : 'è¦ãƒ•ã‚©ãƒ­ãƒ¼'} |\n\n`;

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ å±¥æ­´ï¼ˆè©³ç´°ï¼‰
  report += `## ğŸ“… ã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ å±¥æ­´\n\n`;
  report += `| é€± | ã‚·ãƒŠãƒªã‚ª | ç¯„å›² | ãƒ†ãƒ¼ãƒ | å®Ÿæ–½æ—¥ | ã‚´ãƒ¼ãƒ«é”æˆ | æº€è¶³åº¦ | æ°—ã¥ã | è©±ã—ã‚„ã™ã• | æ„æ¬² |\n`;
  report += `|---|---|---|---|---|---|---|---|---|---|\n`;

  for (let week = 1; week <= 5; week++) {
    const session = allSessions[week];
    const survey = allSurveys[week];
    const scenario = weeklyScenario[week];
    
    if (session) {
      const date = new Date(session.completedAt).toLocaleDateString('ja-JP');
      const r = survey?.responses || {};
      const goalAchievement = r.awareness >= 4 ? 'â—' : r.awareness >= 3 ? 'â—‹' : r.awareness >= 1 ? 'â–³' : '-';
      report += `| ${week} | ${scenario?.scenarioWeek || '-'} | ${scenario?.scope || '-'} | ${session.theme} | ${date} | ${goalAchievement} | ${r.satisfaction || '-'} | ${r.awareness || '-'} | ${r.ease || '-'} | ${r.motivation || '-'} |\n`;
    } else {
      report += `| ${week} | ${scenario?.scenarioWeek || '-'} | ${scenario?.scope || '-'} | ${scenario?.scopeLabel || 'æœªå®Ÿæ–½'} | - | - | - | - | - | - |\n`;
    }
  }
  report += '\n';

  // å„é€±ã®ã‚´ãƒ¼ãƒ«é”æˆçŠ¶æ³
  report += `## ğŸ¯ å„é€±ã®ã‚´ãƒ¼ãƒ«é”æˆçŠ¶æ³\n\n`;
  for (let week = 1; week <= 5; week++) {
    const session = allSessions[week];
    const scenario = weeklyScenario[week];
    const survey = allSurveys[week];
    
    if (session && scenario) {
      report += `### ${week}é€±ç›®ï¼ˆã‚·ãƒŠãƒªã‚ª${scenario.scenarioWeek}ï¼‰: ${scenario.scopeLabel}ï¼ˆ${scenario.scope}ï¼‰\n`;
      report += `**è¨­å®šã‚´ãƒ¼ãƒ«**: ${scenario.goal}\n`;
      
      const achievementLevel = survey?.responses?.awareness >= 4 ? 'é”æˆ' : 
                               survey?.responses?.awareness >= 3 ? 'æ¦‚ã­é”æˆ' : 
                               survey?.responses?.awareness >= 1 ? 'ä¸€éƒ¨é”æˆ' : 'æœªè©•ä¾¡';
      report += `**é”æˆåº¦**: ${achievementLevel}\n`;
      
      if (session.summary) {
        report += `**ã‚µãƒãƒªãƒ¼**: ${session.summary}\n`;
      }
      report += '\n';
    }
  }

  // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ¨ç§»åˆ†æ
  report += `## ğŸ“ˆ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆæ¨ç§»åˆ†æ\n\n`;
  
  const surveyTrend = [];
  for (let week = 1; week <= 5; week++) {
    const survey = allSurveys[week];
    if (survey?.responses) {
      surveyTrend.push({ week, ...survey.responses });
    }
  }

  if (surveyTrend.length >= 2) {
    const first = surveyTrend[0];
    const last = surveyTrend[surveyTrend.length - 1];
    
    const satisfactionTrend = (last.satisfaction || 0) - (first.satisfaction || 0);
    const awarenessTrend = (last.awareness || 0) - (first.awareness || 0);
    const easeTrend = (last.ease || 0) - (first.ease || 0);
    const motivationTrend = (last.motivation || 0) - (first.motivation || 0);

    report += `### å¤‰åŒ–å‚¾å‘\n`;
    report += `| é …ç›® | åˆå›(${first.week}é€±ç›®) | æœ€çµ‚(${last.week}é€±ç›®) | å¤‰åŒ– | å‚¾å‘ |\n|---|---|---|---|---|\n`;
    report += `| æº€è¶³åº¦ | ${first.satisfaction || '-'} | ${last.satisfaction || '-'} | ${satisfactionTrend > 0 ? '+' : ''}${satisfactionTrend} | ${satisfactionTrend > 0 ? 'ğŸ“ˆ å‘ä¸Š' : satisfactionTrend < 0 ? 'ğŸ“‰ ä½ä¸‹' : 'â¡ï¸ ç¶­æŒ'} |\n`;
    report += `| æ°—ã¥ã | ${first.awareness || '-'} | ${last.awareness || '-'} | ${awarenessTrend > 0 ? '+' : ''}${awarenessTrend} | ${awarenessTrend > 0 ? 'ğŸ“ˆ å‘ä¸Š' : awarenessTrend < 0 ? 'ğŸ“‰ ä½ä¸‹' : 'â¡ï¸ ç¶­æŒ'} |\n`;
    report += `| è©±ã—ã‚„ã™ã• | ${first.ease || '-'} | ${last.ease || '-'} | ${easeTrend > 0 ? '+' : ''}${easeTrend} | ${easeTrend > 0 ? 'ğŸ“ˆ å‘ä¸Š' : easeTrend < 0 ? 'ğŸ“‰ ä½ä¸‹' : 'â¡ï¸ ç¶­æŒ'} |\n`;
    report += `| æ¬¡å›æ„æ¬² | ${first.motivation || '-'} | ${last.motivation || '-'} | ${motivationTrend > 0 ? '+' : ''}${motivationTrend} | ${motivationTrend > 0 ? 'ğŸ“ˆ å‘ä¸Š' : motivationTrend < 0 ? 'ğŸ“‰ ä½ä¸‹' : 'â¡ï¸ ç¶­æŒ'} |\n\n`;

    // å‚¾å‘ã®è§£é‡ˆ
    report += `### å‚¾å‘ã®è§£é‡ˆ\n`;
    if (satisfactionTrend > 0 && awarenessTrend > 0) {
      report += `- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’é€šã˜ã¦æº€è¶³åº¦ã¨æ°—ã¥ããŒå‘ä¸Šã—ã¦ãŠã‚Šã€åŠ¹æœçš„ãªè‡ªå·±æ¢æ±‚ãŒè¡Œã‚ã‚ŒãŸã¨è€ƒãˆã‚‰ã‚Œã¾ã™\n`;
    } else if (satisfactionTrend < 0 || awarenessTrend < 0) {
      report += `- ä¸€éƒ¨ã®æŒ‡æ¨™ã«ä½ä¸‹å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ã®æ©Ÿä¼šã‚’æ¤œè¨ã—ã¦ãã ã•ã„\n`;
    }
    if (easeTrend > 0) {
      report += `- è©±ã—ã‚„ã™ã•ãŒå‘ä¸Šã—ã¦ãŠã‚Šã€AIã¨ã®å¯¾è©±ã«æ…£ã‚Œã¦ã„ã£ãŸã“ã¨ãŒä¼ºãˆã¾ã™\n`;
    }
    report += '\n';
  }

  // AIåˆ†æï¼ˆäººäº‹å‘ã‘ï¼‰
  report += `## ğŸ” äººäº‹è¦–ç‚¹ã§ã®åˆ†æ\n\n`;

  const summaries = Object.values(allSessions)
    .filter(s => s.summary)
    .map(s => {
      const scenario = weeklyScenario[s.week];
      return `${s.week}é€±ç›®ï¼ˆ${scenario?.scope || ''}: ${scenario?.scopeLabel || ''}ï¼‰: ${s.summary}`;
    })
    .join('\n');

  if (summaries) {
    try {
      const hrAnalysis = await openai.chat.completions.create({
        model: 'gpt-4',
        messages: [
          {
            role: 'system',
            content: `ã‚ãªãŸã¯äººäº‹æ‹…å½“è€…å‘ã‘ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ã€Œã¯ãŸã‚‰ãWell-beingã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®çµæœã‚’åˆ†æã—ã€ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰å®¢è¦³çš„ã‹ã¤å»ºè¨­çš„ãªæ‰€è¦‹ã‚’æä¾›ã—ã¾ã™ï¼š
- Iï¼ˆå€‹äººï¼‰ï¼šå€‹äººã¨ã—ã¦ã®ä¾¡å€¤è¦³ã€è‡ªå·±ç†è§£ã®æ·±ã¾ã‚Š
- WEï¼ˆéƒ¨ç½²ãƒ»ãƒãƒ¼ãƒ ï¼‰ï¼šçµ„ç¹”ã¨ã®é–¢ã‚ã‚Šã€å½¹å‰²æ„è­˜
- Sï¼ˆä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ï¼šã‚ˆã‚Šå¤§ããªè¦–ç‚¹ã§ã®è²¢çŒ®æ„è­˜ã€ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¸ã®å…±æ„Ÿ
è©•ä¾¡çš„ãƒ»åˆ¤æ–­çš„ã«ãªã‚Šã™ããšã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªå¯èƒ½æ€§ã‚’è¦‹å‡ºã™å§¿å‹¢ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`
          },
          {
            role: 'user',
            content: `ä»¥ä¸‹ã®å¾“æ¥­å“¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚µãƒãƒªãƒ¼ã‚’åˆ†æã—ã€äººäº‹æ‹…å½“è€…å‘ã‘ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

${summaries}

ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

### Iï¼ˆå€‹äººï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã®æ‰€è¦‹
- ã“ã®å¾“æ¥­å“¡ãŒæŒã¤å€‹äººçš„ãªä¾¡å€¤è¦³ã¨è‡ªå·±ç†è§£ã®çŠ¶æ³

### WEï¼ˆéƒ¨ç½²ãƒ»ãƒãƒ¼ãƒ ï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã®æ‰€è¦‹
- ãƒãƒ¼ãƒ ã‚„éƒ¨ç½²ã¨ã®é–¢ã‚ã‚Šã«ãŠã‘ã‚‹ç‰¹å¾´ã¨èª²é¡Œæ„è­˜

### Sï¼ˆä¼šç¤¾ãƒ»ç¤¾ä¼šï¼‰ã®è¦–ç‚¹ã‹ã‚‰ã®æ‰€è¦‹
- ä¼šç¤¾ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ»ãƒ“ã‚¸ãƒ§ãƒ³ã¸ã®å…±æ„Ÿåº¦ã€ç¤¾ä¼šè²¢çŒ®ã¸ã®å¿—å‘

### ä¾¡å€¤è¦³ãƒ»å¼·ã¿ã®ç‰¹å¾´
- ã“ã®å¾“æ¥­å“¡ãŒæŒã¤ä¸»ãªä¾¡å€¤è¦³ã¨å¼·ã¿ï¼ˆ2-3é …ç›®ï¼‰

### çµ„ç¹”ã¸ã®è²¢çŒ®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
- ãƒãƒ¼ãƒ ã‚„çµ„ç¹”ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ãªè²¢çŒ®ãŒæœŸå¾…ã§ãã‚‹ã‹

### ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã®çŠ¶æ…‹
- ä»•äº‹ã‚„çµ„ç¹”ã¸ã®ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆçŠ¶æ…‹ã®æ‰€è¦‹

### ã‚­ãƒ£ãƒªã‚¢å¿—å‘
- è¦‹ã‚‰ã‚Œã‚‹ã‚­ãƒ£ãƒªã‚¢å¿—å‘ã‚„æˆé•·æ„æ¬²

### æ¨å¥¨ã•ã‚Œã‚‹ã‚µãƒãƒ¼ãƒˆ
- äººäº‹ãƒ»ä¸Šå¸ã¨ã—ã¦æ¤œè¨ã™ã¹ãã‚µãƒãƒ¼ãƒˆã‚„æ©Ÿä¼šæä¾›

å„é …ç›®2-3æ–‡ç¨‹åº¦ã§ã€å®¢è¦³çš„ã‹ã¤å»ºè¨­çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚`
          }
        ],
        temperature: 0.7,
        max_tokens: 1500
      });

      report += hrAnalysis.choices[0].message.content + '\n\n';
    } catch (error) {
      console.error('HR Analysis generation error:', error);
      report += '_åˆ†æã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ_\n\n';
    }
  }

  // å‚åŠ è€…ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆåŸæ–‡ï¼‰
  report += `## ğŸ’¬ å‚åŠ è€…ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆåŸæ–‡ï¼‰\n\n`;
  let hasComments = false;
  for (let week = 1; week <= 5; week++) {
    const survey = allSurveys[week];
    const scenario = weeklyScenario[week];
    if (survey?.responses?.feedback) {
      hasComments = true;
      report += `**${week}é€±ç›®ï¼ˆ${scenario?.scopeLabel || ''}ï¼‰**: \n> ${survey.responses.feedback}\n\n`;
    }
  }
  if (!hasComments) {
    report += `_ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆãªã—_\n\n`;
  }

  // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ¨å¥¨ï¼‰
  report += `## ğŸ“Œ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ \n\n`;
  report += `æœ¬ãƒ¬ãƒãƒ¼ãƒˆã‚’è¸ã¾ãˆã€ä»¥ä¸‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ï¼š\n\n`;
  
  if (completedWeeks === 5) {
    report += `1. **1on1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°**: æœ¬äººã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã®æ°—ã¥ãã‚’æ—¥å¸¸æ¥­å‹™ã«æ´»ã‹ã™æ–¹æ³•ã‚’ä¸€ç·’ã«è€ƒãˆã‚‹\n`;
    report += `2. **ã‚­ãƒ£ãƒªã‚¢é–‹ç™º**: æœ¬äººã®ä¾¡å€¤è¦³ã«åˆã£ãŸæˆé•·æ©Ÿä¼šã‚„å½¹å‰²ã‚’æ¤œè¨ã™ã‚‹\n`;
    report += `3. **ãƒãƒ¼ãƒ ã¸ã®å…±æœ‰**: æœ¬äººã®åŒæ„ã‚’å¾—ãŸä¸Šã§ã€ãƒãƒ¼ãƒ å†…ã§ã®ç›¸äº’ç†è§£ä¿ƒé€²ã«æ´»ç”¨ã™ã‚‹\n`;
  } else {
    report += `1. **ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œäº†ã®ä¿ƒé€²**: æ®‹ã‚Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†ã§ãã‚‹ã‚ˆã†ã€æ™‚é–“ç¢ºä¿ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹\n`;
    report += `2. **ä¸­é–“ãƒ•ã‚©ãƒ­ãƒ¼**: ç¾æ™‚ç‚¹ã§ã®æ°—ã¥ãã‚„èª²é¡Œã«ã¤ã„ã¦ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªå¯¾è©±ã®æ©Ÿä¼šã‚’è¨­ã‘ã‚‹\n`;
  }
  report += '\n';

  // æ³¨æ„äº‹é …
  report += `---\n\n`;
  report += `## âš ï¸ æœ¬ãƒ¬ãƒãƒ¼ãƒˆã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦\n\n`;
  report += `- æœ¬ãƒ¬ãƒãƒ¼ãƒˆã¯å¾“æ¥­å“¡ã®ã‚¦ã‚§ãƒ«ãƒ“ãƒ¼ã‚¤ãƒ³ã‚°å‘ä¸Šæ”¯æ´ã‚’ç›®çš„ã¨ã—ã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™\n`;
  report += `- å†…å®¹ã¯è©•ä¾¡ç›®çš„ã§ã¯ãªãã€ã‚µãƒãƒ¼ãƒˆãƒ»è‚²æˆã®å‚è€ƒæƒ…å ±ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„\n`;
  report += `- å€‹äººæƒ…å ±ã¨ã—ã¦é©åˆ‡ã«ç®¡ç†ã—ã€ç›®çš„å¤–åˆ©ç”¨ã¯ãŠæ§ãˆãã ã•ã„\n`;
  report += `- AIåˆ†æã¯å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€æœ€çµ‚çš„ãªåˆ¤æ–­ã¯äººäº‹æ‹…å½“è€…ãŒè¡Œã£ã¦ãã ã•ã„\n`;
  report += `- æœ¬äººã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯ã€åˆ¥é€”ä½œæˆã•ã‚Œã‚‹ã€Œã¾ã¨ã‚ã€ãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ï¼‰ã‚’ã”å‚ç…§ãã ã•ã„\n\n`;

  report += `---\n\n`;
  report += `_æœ¬ãƒ¬ãƒãƒ¼ãƒˆã¯AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ_\n`;
  report += `_ç”Ÿæˆæ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}_\n`;

  return report;
}

// ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/report/generate', async (req, res) => {
  const { userId, userName } = req.body;

  if (!userId) {
    return res.status(400).json({ error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå¿…è¦ã§ã™' });
  }

  try {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const allSessions = getAllUserSessions(userId);
    const allSurveys = getAllUserSurveys(userId);

    if (Object.keys(allSessions).length === 0) {
      return res.status(404).json({ error: 'å®Œäº†ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“' });
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    const displayName = userName || userId;
    const userOutputDir = path.join(outputDir, displayName.replace(/[\/\\:*?"<>|]/g, '_'));
    if (!fs.existsSync(userOutputDir)) {
      fs.mkdirSync(userOutputDir, { recursive: true });
    }

    const generatedFiles = [];

    // å„é€±ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜
    for (let week = 1; week <= 5; week++) {
      const session = allSessions[week];
      if (session) {
        const survey = allSurveys[week];
        const weeklyReport = generateWeeklyReport(session, survey);
        const filename = `${week}é€±ç›®.md`;
        const filepath = path.join(userOutputDir, filename);
        fs.writeFileSync(filepath, weeklyReport, 'utf-8');
        generatedFiles.push(filename);
      }
    }

    // ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®ç·šï¼‰
    const userSummaryReport = await generateUserSummaryReport(userId, displayName, allSessions, allSurveys);
    const userSummaryFilename = 'ã¾ã¨ã‚.md';
    const userSummaryFilepath = path.join(userOutputDir, userSummaryFilename);
    fs.writeFileSync(userSummaryFilepath, userSummaryReport, 'utf-8');
    generatedFiles.push(userSummaryFilename);

    // åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆäººäº‹ç›®ç·šï¼‰
    const hrReport = await generateHRComprehensiveReport(userId, displayName, allSessions, allSurveys);
    const hrReportFilename = 'åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆ.md';
    const hrReportFilepath = path.join(userOutputDir, hrReportFilename);
    fs.writeFileSync(hrReportFilepath, hrReport, 'utf-8');
    generatedFiles.push(hrReportFilename);

    res.json({
      success: true,
      message: 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ',
      outputPath: userOutputDir,
      files: generatedFiles
    });

  } catch (error) {
    console.error('Report generation error:', error);
    res.status(500).json({ error: 'ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', details: error.message });
  }
});

// å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒãƒ¼ãƒˆä¸€æ‹¬ç”Ÿæˆ
app.post('/api/report/generate-all', async (req, res) => {
  try {
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
    const files = fs.readdirSync(sessionsDir);
    const userIds = new Set();
    
    files.forEach(f => {
      if (f.endsWith('.json')) {
        const match = f.match(/^(.+?)_week/);
        if (match) {
          userIds.add(match[1]);
        }
      }
    });

    const results = [];

    for (const userId of userIds) {
      try {
        const allSessions = getAllUserSessions(userId);
        const allSurveys = getAllUserSurveys(userId);

        if (Object.keys(allSessions).length === 0) continue;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ï¼ˆæœ€åˆã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
        const firstSession = Object.values(allSessions)[0];
        const userName = firstSession?.userName || userId;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        const displayName = userName.replace(/[\/\\:*?"<>|]/g, '_');
        const userOutputDir = path.join(outputDir, displayName);
        if (!fs.existsSync(userOutputDir)) {
          fs.mkdirSync(userOutputDir, { recursive: true });
        }

        // å„é€±ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜
        for (let week = 1; week <= 5; week++) {
          const session = allSessions[week];
          if (session) {
            const survey = allSurveys[week];
            const weeklyReport = generateWeeklyReport(session, survey);
            const filepath = path.join(userOutputDir, `${week}é€±ç›®.md`);
            fs.writeFileSync(filepath, weeklyReport, 'utf-8');
          }
        }

        // ã¾ã¨ã‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®ç·šï¼‰
        const userSummaryReport = await generateUserSummaryReport(userId, userName, allSessions, allSurveys);
        const userSummaryFilepath = path.join(userOutputDir, 'ã¾ã¨ã‚.md');
        fs.writeFileSync(userSummaryFilepath, userSummaryReport, 'utf-8');

        // åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ä¿å­˜ï¼ˆäººäº‹ç›®ç·šï¼‰
        const hrReport = await generateHRComprehensiveReport(userId, userName, allSessions, allSurveys);
        const hrReportFilepath = path.join(userOutputDir, 'åŒ…æ‹¬çš„ãƒ¬ãƒãƒ¼ãƒˆ.md');
        fs.writeFileSync(hrReportFilepath, hrReport, 'utf-8');

        results.push({ userId, userName, success: true });
      } catch (userError) {
        results.push({ userId, success: false, error: userError.message });
      }
    }

    res.json({
      success: true,
      message: `${results.filter(r => r.success).length}åã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ`,
      results
    });

  } catch (error) {
    console.error('Batch report generation error:', error);
    res.status(500).json({ error: 'ä¸€æ‹¬ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', details: error.message });
  }
});

// GitåŒæœŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post('/api/git/sync', async (req, res) => {
  const { exec } = require('child_process');
  const util = require('util');
  const execPromise = util.promisify(exec);

  try {
    // Git add
    await execPromise('git add -A', { cwd: __dirname });
    
    // Git commit (å¤‰æ›´ãŒãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†ã«)
    const commitMessage = `ãƒ‡ãƒ¼ã‚¿åŒæœŸ: ${new Date().toLocaleString('ja-JP')}`;
    try {
      await execPromise(`git commit -m "${commitMessage}"`, { cwd: __dirname });
    } catch (commitError) {
      // å¤‰æ›´ãŒãªã„å ´åˆã¯ç„¡è¦–
      if (!commitError.message.includes('nothing to commit')) {
        throw commitError;
      }
    }

    // Git pull (ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’é¿ã‘ã‚‹ãŸã‚ã€å…ˆã«pull)
    try {
      await execPromise('git pull --rebase', { cwd: __dirname });
    } catch (pullError) {
      console.log('Pull skipped or failed:', pullError.message);
    }

    // Git push
    await execPromise('git push', { cwd: __dirname });

    res.json({ success: true, message: 'GitåŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ' });
  } catch (error) {
    console.error('Git sync error:', error);
    res.status(500).json({ 
      success: false, 
      error: 'GitåŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 
      details: error.message 
    });
  }
});

// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä¿å­˜ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
const surveysDir = path.join(__dirname, 'data', 'surveys');
if (!fs.existsSync(surveysDir)) {
  fs.mkdirSync(surveysDir, { recursive: true });
}

// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å•å®šç¾©
const surveyQuestions = {
  postSession: [
    {
      id: 'satisfaction',
      type: 'scale',
      question: 'ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æº€è¶³åº¦ã‚’æ•™ãˆã¦ãã ã•ã„',
      min: 1,
      max: 5,
      minLabel: 'ä¸æº€',
      maxLabel: 'æº€è¶³'
    },
    {
      id: 'awareness',
      type: 'scale',
      question: 'æ–°ã—ã„æ°—ã¥ããŒã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ',
      min: 1,
      max: 5,
      minLabel: 'ãªã‹ã£ãŸ',
      maxLabel: 'ãŸãã•ã‚“ã‚ã£ãŸ'
    },
    {
      id: 'ease',
      type: 'scale',
      question: 'è©±ã—ã‚„ã™ã•ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ',
      min: 1,
      max: 5,
      minLabel: 'è©±ã—ã«ãã‹ã£ãŸ',
      maxLabel: 'è©±ã—ã‚„ã™ã‹ã£ãŸ'
    },
    {
      id: 'motivation',
      type: 'scale',
      question: 'æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®æ„æ¬²ã¯ï¼Ÿ',
      min: 1,
      max: 5,
      minLabel: 'ä½ã„',
      maxLabel: 'é«˜ã„'
    },
    {
      id: 'feedback',
      type: 'text',
      question: 'æ”¹å–„ç‚¹ã‚„ã”æ„Ÿæƒ³ãŒã‚ã‚Œã°ãŠèã‹ã›ãã ã•ã„ï¼ˆä»»æ„ï¼‰'
    }
  ]
};

// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å•å–å¾—
app.get('/api/survey/questions', (req, res) => {
  res.json(surveyQuestions);
});

// ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆå›ç­”ä¿å­˜
app.post('/api/survey/submit', (req, res) => {
  const { sessionId, userId, week, responses } = req.body;

  try {
    const surveyData = {
      sessionId,
      userId,
      week,
      responses,
      submittedAt: new Date().toISOString()
    };

    const filename = `survey_${userId}_week${week}_${Date.now()}.json`;
    const filepath = path.join(surveysDir, filename);
    fs.writeFileSync(filepath, JSON.stringify(surveyData, null, 2));

    res.json({ success: true, message: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ' });
  } catch (error) {
    console.error('Survey save error:', error);
    res.status(500).json({ error: 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ' });
  }
});

// Git pull ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆç¾è¡ŒåŒ–ç”¨ï¼‰
app.post('/api/git/pull', async (req, res) => {
  const { exec } = require('child_process');
  const util = require('util');
  const execPromise = util.promisify(exec);

  try {
    const { stdout, stderr } = await execPromise('git pull', { cwd: __dirname });
    res.json({ 
      success: true, 
      message: 'æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ',
      output: stdout || stderr
    });
  } catch (error) {
    console.error('Git pull error:', error);
    res.status(500).json({ 
      success: false, 
      error: 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 
      details: error.message 
    });
  }
});

app.listen(PORT, () => {
  console.log(`ğŸš€ AIãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://localhost:${PORT}`);
});

